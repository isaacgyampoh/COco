<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="theme-color" content="#0d9488">
<title>EVERYTIN ROOM POS</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;font-family:'Outfit',system-ui,sans-serif;background:linear-gradient(135deg,#f0fdfa 0%,#ccfbf1 100%);color:#134e4a;-webkit-font-smoothing:antialiased}
:root{--primary:#0d9488;--primary-dark:#0f766e;--secondary:#64748b;--success:#22c55e;--warning:#f59e0b;--danger:#ef4444;--whatsapp:#25d366;--dark:#0f172a;--white:#ffffff;--glass:rgba(255,255,255,.9);--shadow:0 4px 24px -4px rgba(13,148,136,.15);--safe-top:env(safe-area-inset-top);--safe-bottom:env(safe-area-inset-bottom)}
#loader{position:fixed;inset:0;background:linear-gradient(135deg,#0d9488,#14b8a6,#f59e0b);z-index:9999;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:20px;opacity:0;pointer-events:none;transition:.3s}#loader.on{opacity:1;pointer-events:auto}#loader .spin{width:50px;height:50px;border:4px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite}#loader p{color:#fff;font-size:16px;font-weight:600}#loader h1{color:#fff;font-size:28px;font-weight:800}#loader h1 span{color:#fbbf24}@keyframes spin{to{transform:rotate(360deg)}}
#toast{position:fixed;top:100px;left:50%;transform:translateX(-50%) translateY(-30px);background:var(--dark);color:#fff;padding:16px 32px;border-radius:50px;font-size:15px;font-weight:600;z-index:9999;opacity:0;transition:.3s}#toast.on{opacity:1;transform:translateX(-50%) translateY(0)}#toast.success{background:linear-gradient(135deg,#22c55e,#16a34a)}#toast.error{background:linear-gradient(135deg,#ef4444,#dc2626)}
#login{position:fixed;inset:0;background:linear-gradient(135deg,#0d9488,#14b8a6,#f59e0b);display:flex;align-items:center;justify-content:center;padding:24px;z-index:1000}#login.hide{display:none}.login-wrap{text-align:center}.login-logo{width:100px;height:100px;background:rgba(255,255,255,.2);border-radius:30px;display:flex;align-items:center;justify-content:center;font-size:50px;margin:0 auto 24px}.login-wrap h1{color:#fff;font-size:28px;font-weight:800;margin-bottom:4px}.login-wrap h1 span{color:#fbbf24}.login-wrap>p{color:rgba(255,255,255,.8);font-size:14px;margin-bottom:40px}.login-card{background:var(--white);border-radius:28px;padding:40px 32px;max-width:380px;box-shadow:0 25px 80px rgba(0,0,0,.2)}.login-card h2{font-size:22px;font-weight:700;margin-bottom:8px}.login-card>p{color:#64748b;margin-bottom:32px;font-size:14px}.pin-row{display:flex;gap:14px;justify-content:center;margin-bottom:24px}.pin-box{width:60px;height:70px;border:3px solid #e2e8f0;border-radius:16px;font-size:28px;font-weight:700;text-align:center;background:#f8fafc}.pin-box:focus{outline:none;border-color:var(--primary)}#loginErr{background:#fef2f2;color:#dc2626;padding:14px;border-radius:12px;margin-bottom:20px;display:none;font-size:13px}#loginErr.on{display:block}
#app{display:none;min-height:100%}#app.on{display:block}
.topnav{display:none;position:fixed;top:0;left:0;right:0;height:72px;background:var(--glass);backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,255,255,.5);padding:0 32px;align-items:center;z-index:100}.topnav-logo{display:flex;align-items:center;gap:12px;font-size:20px;font-weight:800}.topnav-logo span{color:var(--warning)}.topnav-logo .icon{width:44px;height:44px;background:linear-gradient(135deg,#0d9488,#14b8a6);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px}.topnav-menu{display:flex;gap:4px;margin-left:32px;flex-wrap:wrap}.topnav-link{padding:10px 16px;border-radius:12px;font-size:13px;font-weight:600;color:#64748b;cursor:pointer;border:none;background:none;position:relative;transition:.2s}.topnav-link:hover{background:rgba(13,148,136,.1);color:var(--primary)}.topnav-link.on{background:var(--primary);color:#fff}.topnav-link.wa{color:var(--whatsapp)}.topnav-link.wa.on{background:var(--whatsapp)}.topnav-badge{position:absolute;top:-4px;right:-4px;min-width:20px;height:20px;background:var(--danger);border-radius:10px;font-size:11px;font-weight:700;color:#fff;display:flex;align-items:center;justify-content:center}.topnav-right{margin-left:auto;display:flex;align-items:center;gap:16px}.topnav-user{display:flex;align-items:center;gap:12px;padding:8px 16px 8px 8px;background:#f1f5f9;border-radius:50px}.topnav-avatar{width:38px;height:38px;background:linear-gradient(135deg,#0d9488,#14b8a6);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}.topnav-logout{padding:10px 20px;background:#fee2e2;border-radius:50px;font-size:13px;font-weight:600;color:#dc2626;cursor:pointer;border:none;transition:.2s}.topnav-logout:hover{background:#fecaca}.adm{display:none!important}body.is-admin .adm{display:flex!important}
.mobhead{display:flex;position:fixed;top:0;left:0;right:0;height:calc(64px + var(--safe-top));padding-top:var(--safe-top);background:var(--glass);backdrop-filter:blur(20px);padding-left:16px;padding-right:16px;align-items:center;gap:12px;z-index:100;border-bottom:1px solid rgba(255,255,255,.5)}.mobhead-logo{display:flex;align-items:center;gap:10px;font-size:17px;font-weight:800;flex:1}.mobhead-logo span{color:var(--warning)}.mobhead-logo .icon{width:40px;height:40px;background:linear-gradient(135deg,#0d9488,#14b8a6);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px}.mobhead-btn{width:44px;height:44px;border-radius:14px;background:#f1f5f9;display:flex;align-items:center;justify-content:center;font-size:20px;border:none;cursor:pointer;position:relative}.mobhead-badge{position:absolute;top:2px;right:2px;min-width:18px;height:18px;background:var(--danger);border-radius:9px;font-size:10px;font-weight:700;color:#fff;display:flex;align-items:center;justify-content:center}.realtime{width:10px;height:10px;background:var(--success);border-radius:50%;animation:pulse 2s infinite}@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(.8)}}
.mobnav{display:flex;position:fixed;bottom:0;left:0;right:0;background:var(--glass);backdrop-filter:blur(20px);padding:10px 20px calc(10px + var(--safe-bottom));z-index:100;border-top:1px solid rgba(255,255,255,.5)}.mobnav-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;padding:8px;border-radius:14px;font-size:11px;font-weight:600;color:#94a3b8;border:none;background:none;cursor:pointer;position:relative;transition:.2s}.mobnav-btn span{font-size:24px}.mobnav-btn.on{color:var(--primary);background:rgba(13,148,136,.1)}.mobnav-btn.wa.on{color:var(--whatsapp);background:rgba(37,211,102,.1)}.mobnav-badge{position:absolute;top:2px;right:50%;transform:translateX(14px);min-width:18px;height:18px;background:var(--danger);border-radius:9px;font-size:10px;font-weight:700;color:#fff;display:flex;align-items:center;justify-content:center}
.cart-float{position:fixed;bottom:calc(100px + var(--safe-bottom));right:20px;width:64px;height:64px;background:linear-gradient(135deg,#0d9488,#14b8a6);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:28px;color:#fff;z-index:99;box-shadow:0 8px 30px rgba(13,148,136,.4);cursor:pointer;border:none;transition:.2s}.cart-float:active{transform:scale(.95)}.cart-float-badge{position:absolute;top:0;right:0;min-width:24px;height:24px;background:var(--danger);border-radius:12px;font-size:12px;font-weight:700;color:#fff;display:flex;align-items:center;justify-content:center;border:3px solid #fff}
#menuBg{position:fixed;inset:0;background:rgba(15,23,42,.6);z-index:200;opacity:0;pointer-events:none;transition:.3s}#menuBg.on{opacity:1;pointer-events:auto}#menuDrawer{position:fixed;top:0;right:0;bottom:0;width:320px;max-width:85%;background:var(--white);z-index:201;transform:translateX(100%);transition:.3s;display:flex;flex-direction:column}#menuDrawer.on{transform:translateX(0)}.drawer-head{display:flex;align-items:center;justify-content:space-between;padding:20px;padding-top:calc(20px + var(--safe-top));border-bottom:1px solid #e2e8f0}.drawer-close{width:44px;height:44px;background:#f1f5f9;border-radius:12px;font-size:22px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center}.drawer-body{flex:1;overflow-y:auto;padding:20px}.drawer-user{background:linear-gradient(135deg,#0d9488,#14b8a6,#f59e0b);border-radius:20px;padding:24px;text-align:center;margin-bottom:24px;color:#fff}.drawer-avatar{width:70px;height:70px;background:rgba(255,255,255,.2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:700;margin:0 auto 12px}.drawer-user h4{font-size:18px;font-weight:700}.drawer-badge{display:inline-block;padding:6px 14px;background:rgba(255,255,255,.2);border-radius:50px;font-size:11px;font-weight:700;margin-top:10px}.drawer-nav{display:flex;flex-direction:column;gap:6px}.drawer-link{display:flex;align-items:center;gap:14px;padding:16px;border-radius:14px;font-size:15px;font-weight:600;color:#64748b;border:none;background:none;cursor:pointer;text-align:left;width:100%;position:relative;transition:.2s}.drawer-link span{font-size:22px;width:28px}.drawer-link:hover{background:#f1f5f9}.drawer-link.on{background:var(--primary);color:#fff}.drawer-link.wa.on{background:var(--whatsapp)}.drawer-link-badge{position:absolute;right:16px;min-width:24px;height:24px;background:var(--danger);border-radius:12px;font-size:12px;font-weight:700;color:#fff;display:flex;align-items:center;justify-content:center}.drawer-foot{padding:20px;padding-bottom:calc(20px + var(--safe-bottom));border-top:1px solid #e2e8f0}.drawer-logout{width:100%;padding:16px;background:#fee2e2;border-radius:14px;font-size:15px;font-weight:600;color:#dc2626;border:none;cursor:pointer;transition:.2s}.drawer-logout:hover{background:#fecaca}
.main{padding-top:calc(64px + var(--safe-top));padding-bottom:calc(90px + var(--safe-bottom));min-height:100%}.container{padding:24px 16px;max-width:1400px;margin:0 auto}
.pg{display:none}.pg.on{display:block;animation:fadeIn .3s}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}.pg-head{margin-bottom:28px}.pg-head-row{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px;margin-bottom:28px}.pg-title{font-size:26px;font-weight:800;margin-bottom:4px}.pg-sub{font-size:14px;color:#64748b}
.card{background:var(--white);border-radius:20px;padding:24px;margin-bottom:16px;box-shadow:var(--shadow)}.card-title{font-size:17px;font-weight:700;margin-bottom:20px;display:flex;align-items:center;gap:10px}
.stats{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;margin-bottom:28px}.stat{background:var(--white);border-radius:20px;padding:20px;box-shadow:var(--shadow)}.stat-icon{font-size:32px;margin-bottom:12px}.stat-label{font-size:12px;font-weight:600;color:#94a3b8;text-transform:uppercase;letter-spacing:.5px}.stat-value{font-size:24px;font-weight:800;margin-top:4px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;height:48px;padding:0 20px;border-radius:14px;font-size:14px;font-weight:600;border:none;cursor:pointer;transition:.2s}.btn:active{transform:scale(.96)}.btn-primary{background:linear-gradient(135deg,#0d9488,#14b8a6);color:#fff}.btn-success{background:var(--success);color:#fff}.btn-danger{background:var(--danger);color:#fff}.btn-warning{background:var(--warning);color:#fff}.btn-whatsapp{background:var(--whatsapp);color:#fff}.btn-ghost{background:#f1f5f9;color:#64748b}.btn-sm{height:40px;padding:0 14px;font-size:13px;border-radius:10px}.btn-full{width:100%}
.field{margin-bottom:18px}.field-label{display:block;font-size:12px;font-weight:600;color:#64748b;margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px}.field-input{width:100%;height:52px;padding:0 16px;background:#f8fafc;border:2px solid #e2e8f0;border-radius:14px;font-size:15px;font-family:inherit;transition:.2s}.field-input:focus{outline:none;border-color:var(--primary);background:#fff}textarea.field-input{height:100px;padding:16px;resize:none}.field-row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.badge{display:inline-block;padding:6px 12px;border-radius:8px;font-size:11px;font-weight:700;text-transform:uppercase}.badge-success{background:rgba(34,197,94,.1);color:var(--success)}.badge-warning{background:rgba(245,158,11,.1);color:var(--warning)}.badge-danger{background:rgba(239,68,68,.1);color:var(--danger)}.badge-whatsapp{background:rgba(37,211,102,.1);color:#128c7e}.badge-primary{background:rgba(13,148,136,.1);color:var(--primary)}
.tabs{display:flex;gap:10px;overflow-x:auto;margin-bottom:24px;padding-bottom:4px}.tab{height:44px;padding:0 20px;background:var(--white);border:2px solid #e2e8f0;border-radius:12px;font-size:14px;font-weight:600;color:#64748b;white-space:nowrap;cursor:pointer;transition:.2s}.tab.on{background:var(--primary);color:#fff;border-color:transparent}.tab.wa.on{background:var(--whatsapp)}
.hero{background:linear-gradient(135deg,#0d9488,#14b8a6);border-radius:24px;padding:28px;color:#fff;margin-bottom:24px}.hero.wa{background:linear-gradient(135deg,#25d366,#128c7e)}.hero.danger{background:linear-gradient(135deg,#ef4444,#dc2626)}.hero.success{background:linear-gradient(135deg,#22c55e,#16a34a)}.hero small{font-size:14px;opacity:.9}.hero strong{display:block;font-size:36px;font-weight:800;margin-top:8px}
.products{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}.product{background:var(--white);border-radius:18px;padding:14px;cursor:pointer;box-shadow:var(--shadow);border:3px solid transparent;transition:.2s}.product:active{border-color:var(--primary);transform:scale(.98)}.product.out{opacity:.4;pointer-events:none}.product-img{width:100%;height:90px;background:linear-gradient(135deg,#f0fdfa,#ccfbf1);border-radius:12px;margin-bottom:12px;display:flex;align-items:center;justify-content:center;font-size:36px;overflow:hidden}.product-img img{width:100%;height:100%;object-fit:cover}.product-name{font-size:13px;font-weight:600;margin-bottom:8px;line-height:1.3}.product-price{font-size:18px;font-weight:800;color:var(--primary)}.product-stock{display:inline-flex;padding:5px 10px;border-radius:50px;font-size:10px;font-weight:700;margin-top:8px}.product-stock.ok{background:rgba(34,197,94,.1);color:var(--success)}.product-stock.low{background:rgba(245,158,11,.1);color:var(--warning)}.product-stock.out{background:rgba(239,68,68,.1);color:var(--danger)}
.cat-filter{display:flex;gap:10px;overflow-x:auto;margin-bottom:20px;padding-bottom:4px}.cat-chip{height:40px;padding:0 18px;background:var(--white);border:2px solid #e2e8f0;border-radius:50px;font-size:13px;font-weight:600;color:#64748b;white-space:nowrap;cursor:pointer;transition:.2s}.cat-chip.on{background:var(--primary);color:#fff;border-color:transparent}
.modes{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:24px}.mode{height:70px;background:var(--white);border:3px solid #e2e8f0;border-radius:16px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;font-size:12px;font-weight:700;color:#94a3b8;cursor:pointer;transition:.2s}.mode span{font-size:26px}.mode.on{border-color:var(--primary);color:var(--primary);background:rgba(13,148,136,.05)}.mode.wh.on{border-color:var(--warning);color:var(--warning);background:rgba(245,158,11,.05)}.mode.bu.on{border-color:#8b5cf6;color:#8b5cf6;background:rgba(139,92,246,.05)}
.search-box{position:relative;margin-bottom:20px}.search-box input{padding-left:52px;height:56px;border-radius:16px;font-size:16px}.search-box::before{content:'ğŸ”';position:absolute;left:18px;top:50%;transform:translateY(-50%);font-size:20px}
.wa-orders{display:flex;flex-direction:column;gap:16px}.wa-order{background:var(--white);border-radius:20px;padding:20px;box-shadow:var(--shadow);border-left:5px solid var(--whatsapp)}.wa-order.completed{border-left-color:var(--success);opacity:.7}.wa-order.cancelled{border-left-color:var(--danger);opacity:.5}.wa-order-head{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;flex-wrap:wrap;gap:10px}.wa-order-id{font-size:18px;font-weight:700}.wa-order-time{font-size:13px;color:#94a3b8}.wa-order-status{padding:6px 14px;border-radius:50px;font-size:12px;font-weight:700}.wa-order-status.pending{background:rgba(37,211,102,.1);color:var(--whatsapp)}.wa-order-status.completed{background:rgba(34,197,94,.1);color:var(--success)}.wa-order-status.cancelled{background:rgba(239,68,68,.1);color:var(--danger)}.wa-order-customer{display:flex;align-items:center;gap:12px;padding:14px;background:#f8fafc;border-radius:14px;margin-bottom:12px}.wa-order-avatar{width:44px;height:44px;background:var(--whatsapp);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:20px}.wa-order-info h4{font-size:15px;font-weight:600}.wa-order-info p{font-size:13px;color:#64748b;margin-top:2px}.wa-order-items{margin-bottom:12px}.wa-order-item{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed #e2e8f0;font-size:14px}.wa-order-item:last-child{border-bottom:none}.wa-order-item span{color:#64748b}.wa-order-item b{color:var(--dark)}.wa-order-footer{display:flex;justify-content:space-between;align-items:center;padding-top:12px;border-top:2px solid #f1f5f9;flex-wrap:wrap;gap:12px}.wa-order-total{font-size:22px;font-weight:800;color:var(--primary)}.action-btns{display:flex;gap:8px;flex-wrap:wrap}
#cartBg{position:fixed;inset:0;background:rgba(15,23,42,.6);z-index:300;opacity:0;pointer-events:none;transition:.3s}#cartBg.on{opacity:1;pointer-events:auto}#cartDrawer{position:fixed;bottom:0;left:0;right:0;background:var(--white);border-radius:28px 28px 0 0;max-height:92vh;z-index:301;transform:translateY(100%);transition:.35s;display:flex;flex-direction:column}#cartDrawer.on{transform:translateY(0)}.cart-bar{width:48px;height:5px;background:#e2e8f0;border-radius:3px;margin:14px auto}.cart-head{display:flex;align-items:center;justify-content:space-between;padding:0 24px 20px;border-bottom:1px solid #e2e8f0}.cart-head h3{font-size:20px;font-weight:800}.cart-count{background:var(--primary);color:#fff;padding:6px 14px;border-radius:50px;font-size:14px;font-weight:700}.cart-body{flex:1;overflow-y:auto;padding:20px 24px;max-height:40vh}.cart-item{display:flex;align-items:center;gap:12px;padding:14px;background:#f8fafc;border-radius:14px;margin-bottom:10px}.cart-item-img{width:48px;height:48px;background:linear-gradient(135deg,#f0fdfa,#ccfbf1);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;overflow:hidden;flex-shrink:0}.cart-item-img img{width:100%;height:100%;object-fit:cover}.cart-item-info{flex:1;min-width:0}.cart-item-name{font-size:14px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.cart-item-price{font-size:12px;color:#64748b;margin-top:2px}.cart-qty{display:flex;align-items:center;gap:6px}.cart-qty-btn{width:36px;height:36px;border-radius:10px;background:#fff;border:2px solid #e2e8f0;font-size:18px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.2s}.cart-qty-btn:active{background:#f1f5f9}.cart-qty-num{font-size:15px;font-weight:700;min-width:24px;text-align:center}.cart-item-total{font-size:14px;font-weight:700;color:var(--primary);min-width:70px;text-align:right}.cart-item-del{width:36px;height:36px;border-radius:10px;background:#fee2e2;color:var(--danger);font-size:16px;display:flex;align-items:center;justify-content:center;border:none;cursor:pointer;flex-shrink:0}.cart-empty{text-align:center;padding:40px;color:#94a3b8}.cart-empty span{font-size:56px;display:block;margin-bottom:12px;opacity:.4}.cart-foot{padding:20px 24px;padding-bottom:calc(20px + var(--safe-bottom));border-top:1px solid #e2e8f0;background:#fafafa}.cart-summary{margin-bottom:16px}.cart-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;font-size:14px;color:#64748b}.cart-row b{color:var(--dark)}.cart-row.total{font-size:20px;font-weight:800;padding-top:12px;border-top:2px dashed #e2e8f0}.cart-row.total b{color:var(--primary)}.disc-input{width:80px;height:40px;padding:0 10px;background:#fff;border:2px solid #e2e8f0;border-radius:10px;font-size:14px;font-weight:600;text-align:right}.cust-btn{width:100%;height:50px;background:rgba(13,148,136,.05);border:2px dashed rgba(13,148,136,.3);border-radius:14px;font-size:14px;font-weight:600;color:var(--primary);cursor:pointer;margin-bottom:12px;transition:.2s}.cust-btn.sel{background:rgba(13,148,136,.1);border-style:solid}.checkout-btn{width:100%;height:56px;background:linear-gradient(135deg,#22c55e,#16a34a);border-radius:14px;color:#fff;font-size:17px;font-weight:700;border:none;cursor:pointer;transition:.2s}.checkout-btn:disabled{opacity:.5}.checkout-btn:active{transform:scale(.98)}
.modal{position:fixed;inset:0;z-index:400;display:none;align-items:flex-end;justify-content:center}.modal.on{display:flex}.modal-bg{position:absolute;inset:0;background:rgba(15,23,42,.6)}.modal-box{position:relative;background:var(--white);border-radius:28px 28px 0 0;width:100%;max-height:90vh;display:flex;flex-direction:column;animation:slideUp .3s}@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}.modal-head{display:flex;align-items:center;justify-content:space-between;padding:24px;border-bottom:1px solid #e2e8f0}.modal-head h3{font-size:20px;font-weight:700}.modal-close{width:44px;height:44px;background:#f1f5f9;border-radius:12px;font-size:22px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center}.modal-body{flex:1;overflow-y:auto;padding:24px}.modal-foot{padding:20px 24px calc(20px + var(--safe-bottom));border-top:1px solid #e2e8f0;display:flex;gap:12px}
.tbl-wrap{overflow-x:auto;margin:-24px;margin-top:0;padding:0 24px 24px}table{width:100%;border-collapse:collapse;min-width:500px}th{text-align:left;padding:14px 12px;background:#f8fafc;font-size:11px;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:.5px}td{padding:14px 12px;border-bottom:1px solid #f1f5f9;font-size:14px}.tbl-empty{text-align:center;padding:48px;color:#94a3b8}.tbl-empty span{font-size:56px;display:block;margin-bottom:12px;opacity:.3}
.report-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}.report-card{background:var(--white);border-radius:20px;padding:24px;box-shadow:var(--shadow)}.report-card h4{font-size:13px;font-weight:600;color:#64748b;margin-bottom:8px}.report-card .value{font-size:26px;font-weight:800;color:var(--dark)}.report-card .value.success{color:var(--success)}.report-card .value.danger{color:var(--danger)}
.top-product{display:flex;align-items:center;gap:12px;padding:14px;background:#f8fafc;border-radius:14px;margin-bottom:10px}.top-product-rank{width:32px;height:32px;background:linear-gradient(135deg,#0d9488,#14b8a6);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;flex-shrink:0}.top-product-rank.gold{background:linear-gradient(135deg,#f59e0b,#d97706)}.top-product-rank.silver{background:linear-gradient(135deg,#94a3b8,#64748b)}.top-product-rank.bronze{background:linear-gradient(135deg,#d97706,#b45309)}.top-product-info{flex:1;min-width:0}.top-product-name{font-weight:600;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.top-product-qty{font-size:12px;color:#64748b}.top-product-total{font-weight:700;color:var(--primary)}
.cust-item{background:var(--white);border-radius:16px;padding:16px;box-shadow:var(--shadow);margin-bottom:12px;display:flex;align-items:center;gap:14px;cursor:pointer;transition:.2s}.cust-item:active{transform:scale(.98)}.cust-avatar{width:50px;height:50px;background:linear-gradient(135deg,#0d9488,#14b8a6);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:20px;font-weight:700;flex-shrink:0}.cust-info{flex:1;min-width:0}.cust-name{font-size:15px;font-weight:700}.cust-phone{font-size:13px;color:#64748b;margin-top:2px}.cust-stats{display:flex;gap:16px;margin-top:6px}.cust-stat-val{font-size:14px;font-weight:700;color:var(--primary)}.cust-stat-lbl{font-size:10px;color:#94a3b8}
.stock-item{display:flex;align-items:center;gap:16px;padding:16px;background:#f8fafc;border-radius:14px;margin-bottom:12px;border-left:4px solid #e2e8f0}.stock-item.pos{border-left-color:var(--success)}.stock-item.neg{border-left-color:var(--danger)}.stock-item-info{flex:1}.stock-item-name{font-weight:600;margin-bottom:4px}.stock-item-current{font-size:13px;color:#64748b}.stock-item-input{width:80px;height:44px;text-align:center;font-size:16px;font-weight:700;border:2px solid #e2e8f0;border-radius:10px}.stock-item-input:focus{outline:none;border-color:var(--primary)}.stock-var{min-width:50px;text-align:center;font-weight:700;padding:6px 10px;border-radius:8px;font-size:13px}.stock-var.pos{background:rgba(34,197,94,.1);color:var(--success)}.stock-var.neg{background:rgba(239,68,68,.1);color:var(--danger)}.stock-var.zero{background:#f1f5f9;color:#64748b}
.exp-item{display:flex;align-items:center;gap:14px;padding:16px;background:#f8fafc;border-radius:14px;margin-bottom:10px}.exp-icon{width:44px;height:44px;background:rgba(239,68,68,.1);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}.exp-info{flex:1;min-width:0}.exp-title{font-weight:600;font-size:14px}.exp-date{font-size:12px;color:#64748b;margin-top:2px}.exp-amt{font-weight:700;color:var(--danger);font-size:15px}
.img-upload{margin-bottom:18px}.img-upload-area{width:100%;height:140px;background:#f8fafc;border:3px dashed #e2e8f0;border-radius:16px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;overflow:hidden;position:relative;transition:.2s}.img-upload-area:hover{border-color:var(--primary)}.img-upload-area.has-img{border-style:solid;border-color:var(--success)}.img-upload-area img{width:100%;height:100%;object-fit:cover}.img-upload-area .placeholder{display:flex;flex-direction:column;align-items:center;gap:8px;color:#94a3b8}.img-upload-area .placeholder span{font-size:36px}.img-upload-input{display:none}
@media(min-width:768px){.mobhead,.mobnav{display:none}#menuBg,#menuDrawer{display:none!important}.topnav{display:flex}.main{padding-top:72px;padding-bottom:40px}.container{padding:32px 40px}.cart-float{bottom:32px;right:32px}.stats{grid-template-columns:repeat(4,1fr)}.products{grid-template-columns:repeat(3,1fr);gap:20px}.modal{align-items:center;padding:32px}.modal-box{border-radius:24px;max-width:520px}#cartDrawer{max-width:440px;right:0;left:auto;border-radius:28px 0 0 28px;max-height:100vh}.report-grid{grid-template-columns:repeat(4,1fr)}}
@media(min-width:1024px){.products{grid-template-columns:repeat(4,1fr)}}
@media print{body *{visibility:hidden}#printArea,#printArea *{visibility:visible}#printArea{position:fixed;left:0;top:0;width:80mm;padding:3mm;background:#fff;font-family:'Courier New',monospace;font-size:12px}}
</style>
</head>
<body>
<div id="loader" class="on"><h1>Everytin <span>Room</span></h1><div class="spin"></div><p id="loaderText">Loading...</p></div>
<div id="toast"></div>
<div id="login">
<div class="login-wrap">
<div class="login-logo">ğŸ›’</div>
<h1>Everytin <span>Room</span></h1>
<p>Your One Stop Shop â€¢ Point of Sale</p>
<div class="login-card">
<h2>Welcome Back!</h2>
<p>Enter your 4-digit PIN</p>
<div id="loginErr">Invalid PIN. Try again.</div>
<div class="pin-row">
<input type="tel" maxlength="1" class="pin-box" id="p1" oninput="pinInput(1)" inputmode="numeric">
<input type="tel" maxlength="1" class="pin-box" id="p2" oninput="pinInput(2)" inputmode="numeric">
<input type="tel" maxlength="1" class="pin-box" id="p3" oninput="pinInput(3)" inputmode="numeric">
<input type="tel" maxlength="1" class="pin-box" id="p4" oninput="pinInput(4)" inputmode="numeric">
</div>
</div>
</div>
</div>
<div id="app">
<nav class="topnav">
<div class="topnav-logo"><div class="icon">ğŸ›’</div>Everytin <span>Room</span></div>
<div class="topnav-menu">
<button class="topnav-link adm on" data-pg="dash" onclick="goTo('dash')">ğŸ“Š Dashboard</button>
<button class="topnav-link wa" data-pg="orders" onclick="goTo('orders')">ğŸ“± WhatsApp<span class="topnav-badge" id="waBadgeTop">0</span></button>
<button class="topnav-link" data-pg="pos" onclick="goTo('pos')">ğŸ›’ POS</button>
<button class="topnav-link" data-pg="receipts" onclick="goTo('receipts')">ğŸ§¾ Receipts</button>
<button class="topnav-link adm" data-pg="products" onclick="goTo('products')">ğŸ“¦ Products</button>
<button class="topnav-link adm" data-pg="bundles" onclick="goTo('bundles')">ğŸ Bundles</button>
<button class="topnav-link adm" data-pg="customers" onclick="goTo('customers')">ğŸ‘¥ Customers</button>
<button class="topnav-link adm" data-pg="expenses" onclick="goTo('expenses')">ğŸ’¸ Expenses</button>
<button class="topnav-link adm" data-pg="stock" onclick="goTo('stock')">ğŸ“‹ Stock Take</button>
<button class="topnav-link adm" data-pg="reports" onclick="goTo('reports')">ğŸ“ˆ Reports</button>
<button class="topnav-link adm" data-pg="staff" onclick="goTo('staff')">ğŸ‘¤ Staff</button>
</div>
<div class="topnav-right">
<div class="realtime" title="Live Connected"></div>
<div class="topnav-user"><div class="topnav-avatar" id="topAv">A</div><span id="topNm">Admin</span></div>
<button class="topnav-logout" onclick="logout()">Sign Out</button>
</div>
</nav>
<header class="mobhead">
<div class="mobhead-logo"><div class="icon">ğŸ›’</div>Everytin <span>Room</span></div>
<div class="realtime"></div>
<button class="mobhead-btn" onclick="goTo('orders')" style="background:rgba(37,211,102,.1)">ğŸ“±<span class="mobhead-badge" id="waBadgeMob">0</span></button>
<button class="mobhead-btn" onclick="openMenu()">â˜°</button>
</header>
<button class="cart-float" onclick="openCart()">ğŸ›’<span class="cart-float-badge" id="cartBadge">0</span></button>
<div id="menuBg" onclick="closeMenu()"></div>
<div id="menuDrawer">
<div class="drawer-head"><h3>Menu</h3><button class="drawer-close" onclick="closeMenu()">âœ•</button></div>
<div class="drawer-body">
<div class="drawer-user"><div class="drawer-avatar" id="drAv">A</div><h4 id="drNm">Admin</h4><span class="drawer-badge" id="drBg">ADMIN</span></div>
<nav class="drawer-nav">
<button class="drawer-link adm on" data-pg="dash" onclick="goTo('dash')"><span>ğŸ“Š</span>Dashboard</button>
<button class="drawer-link wa" data-pg="orders" onclick="goTo('orders')"><span>ğŸ“±</span>WhatsApp<span class="drawer-link-badge" id="waBadgeDr">0</span></button>
<button class="drawer-link" data-pg="pos" onclick="goTo('pos')"><span>ğŸ›’</span>Point of Sale</button>
<button class="drawer-link" data-pg="receipts" onclick="goTo('receipts')"><span>ğŸ§¾</span>Receipts</button>
<button class="drawer-link adm" data-pg="products" onclick="goTo('products')"><span>ğŸ“¦</span>Products</button>
<button class="drawer-link adm" data-pg="bundles" onclick="goTo('bundles')"><span>ğŸ</span>Bundles</button>
<button class="drawer-link adm" data-pg="customers" onclick="goTo('customers')"><span>ğŸ‘¥</span>Customers</button>
<button class="drawer-link adm" data-pg="expenses" onclick="goTo('expenses')"><span>ğŸ’¸</span>Expenses</button>
<button class="drawer-link adm" data-pg="stock" onclick="goTo('stock')"><span>ğŸ“‹</span>Stock Take</button>
<button class="drawer-link adm" data-pg="reports" onclick="goTo('reports')"><span>ğŸ“ˆ</span>Reports</button>
<button class="drawer-link adm" data-pg="staff" onclick="goTo('staff')"><span>ğŸ‘¤</span>Staff</button>
</nav>
</div>
<div class="drawer-foot"><button class="drawer-logout" onclick="logout()">ğŸšª Sign Out</button></div>
</div>
<nav class="mobnav">
<button class="mobnav-btn on" data-pg="pos" onclick="goTo('pos')"><span>ğŸ›’</span>Sale</button>
<button class="mobnav-btn wa" data-pg="orders" onclick="goTo('orders')"><span>ğŸ“±</span>Orders<span class="mobnav-badge" id="waBadgeNav">0</span></button>
<button class="mobnav-btn" data-pg="receipts" onclick="goTo('receipts')"><span>ğŸ§¾</span>History</button>
<button class="mobnav-btn adm" data-pg="dash" onclick="goTo('dash')"><span>ğŸ“Š</span>More</button>
</nav>
<main class="main"><div class="container">
<!-- DASHBOARD -->
<section class="pg on" id="pgDash">
<div class="pg-head"><h1 class="pg-title">ğŸ“Š Dashboard</h1><p class="pg-sub">Business overview at a glance</p></div>
<div class="stats">
<div class="stat"><div class="stat-icon">ğŸ’°</div><div class="stat-label">Today Sales</div><div class="stat-value" id="dSales">GHS 0</div></div>
<div class="stat"><div class="stat-icon">ğŸ’µ</div><div class="stat-label">Today Profit</div><div class="stat-value" id="dProfit">GHS 0</div></div>
<div class="stat"><div class="stat-icon">ğŸ“±</div><div class="stat-label">Pending Orders</div><div class="stat-value" id="dPending">0</div></div>
<div class="stat"><div class="stat-icon">ğŸ“¦</div><div class="stat-label">Low Stock</div><div class="stat-value" id="dLowStock">0</div></div>
</div>
<div class="card"><div class="card-title">ğŸ† Top Selling Today</div><div id="topToday"></div></div>
</section>

<!-- WHATSAPP ORDERS -->
<section class="pg" id="pgOrders">
<div class="pg-head-row"><div><h1 class="pg-title">ğŸ“± WhatsApp Orders</h1><p class="pg-sub">Manage incoming orders</p></div><button class="btn btn-whatsapp" onclick="loadOrders().then(rOrders)">ğŸ”„ Refresh</button></div>
<div class="hero wa"><small>Pending Orders</small><strong id="pendingCount">0</strong></div>
<div class="tabs" id="waTabs"><button class="tab wa on" onclick="setWAFilter('pending')">ğŸŸ¢ Pending</button><button class="tab" onclick="setWAFilter('completed')">âœ… Completed</button><button class="tab" onclick="setWAFilter('all')">ğŸ“‹ All</button></div>
<div class="wa-orders" id="ordersList"></div>
</section>

<!-- POS -->
<section class="pg" id="pgPos">
<div class="pg-head"><h1 class="pg-title">ğŸ›’ Point of Sale</h1></div>
<div class="search-box"><input type="text" class="field-input" placeholder="Search products..." id="posQ" oninput="rPOS()"></div>
<div class="cat-filter" id="catFilter"></div>
<div class="modes">
<button class="mode on" id="mdRet" onclick="setMode('retail')"><span>ğŸ›ï¸</span>Retail</button>
<button class="mode wh" id="mdWho" onclick="setMode('wholesale')"><span>ğŸ­</span>Wholesale</button>
<button class="mode bu" id="mdBun" onclick="setMode('bundle')"><span>ğŸ</span>Bundle</button>
</div>
<div class="products" id="prodGrid"></div>
</section>

<!-- RECEIPTS -->
<section class="pg" id="pgReceipts">
<div class="pg-head"><h1 class="pg-title">ğŸ§¾ Sales History</h1></div>
<div class="card">
<input type="text" class="field-input" placeholder="ğŸ” Search receipts..." id="rcQ" oninput="rReceipts()" style="margin-bottom:20px">
<div class="tbl-wrap"><table><thead><tr><th>Receipt</th><th>Date</th><th>Customer</th><th>Type</th><th>Total</th><th>Action</th></tr></thead><tbody id="rcTbl"></tbody></table></div>
</div>
</section>

<!-- PRODUCTS -->
<section class="pg" id="pgProducts">
<div class="pg-head-row"><div><h1 class="pg-title">ğŸ“¦ Products</h1><p class="pg-sub">Manage inventory</p></div><button class="btn btn-primary" onclick="openPrModal()">â• Add Product</button></div>
<div class="card">
<input type="text" class="field-input" placeholder="ğŸ” Search products..." id="prQ" oninput="rProducts()" style="margin-bottom:20px">
<div class="tbl-wrap"><table><thead><tr><th>Image</th><th>Product</th><th>Price</th><th>Stock</th><th>Actions</th></tr></thead><tbody id="prTbl"></tbody></table></div>
</div>
</section>

<!-- BUNDLES -->
<section class="pg" id="pgBundles">
<div class="pg-head-row"><div><h1 class="pg-title">ğŸ Bundles</h1><p class="pg-sub">Product bundles at special prices</p></div><button class="btn btn-primary" onclick="openBunModal()">â• Create Bundle</button></div>
<div class="card">
<div class="tbl-wrap"><table><thead><tr><th>Bundle</th><th>Products</th><th>Price</th><th>Savings</th><th>Actions</th></tr></thead><tbody id="bunTbl"></tbody></table></div>
</div>
</section>

<!-- CUSTOMERS -->
<section class="pg" id="pgCustomers">
<div class="pg-head-row"><div><h1 class="pg-title">ğŸ‘¥ Customers</h1><p class="pg-sub">Customer database</p></div><button class="btn btn-primary" onclick="openCustModal()">â• Add Customer</button></div>
<div class="stats" style="grid-template-columns:1fr 1fr 1fr">
<div class="stat"><div class="stat-label">Total Customers</div><div class="stat-value" id="custTotal">0</div></div>
<div class="stat"><div class="stat-label">Total Revenue</div><div class="stat-value" id="custRevenue">GHS 0</div></div>
<div class="stat"><div class="stat-label">Avg. Purchase</div><div class="stat-value" id="custAvg">GHS 0</div></div>
</div>
<div class="card">
<input type="text" class="field-input" placeholder="ğŸ” Search by phone..." id="custQ" oninput="rCustomers()" style="margin-bottom:20px">
<div id="custList"></div>
</div>
</section>

<!-- EXPENSES -->
<section class="pg" id="pgExpenses">
<div class="pg-head-row"><div><h1 class="pg-title">ğŸ’¸ Expenses</h1><p class="pg-sub">Track business expenses</p></div><button class="btn btn-danger" onclick="openExpModal()">â• Add Expense</button></div>
<div class="hero danger"><small>This Month</small><strong id="expMonth">GHS 0</strong></div>
<div class="card"><div id="expList"></div></div>
</section>

<!-- STOCK TAKE -->
<section class="pg" id="pgStock">
<div class="pg-head-row"><div><h1 class="pg-title">ğŸ“‹ Stock Take</h1><p class="pg-sub">Count and adjust inventory</p></div><button class="btn btn-primary" onclick="startStockTake()">ğŸ“‹ New Stock Take</button></div>
<div id="stockArea"></div>
</section>

<!-- REPORTS -->
<section class="pg" id="pgReports">
<div class="pg-head"><h1 class="pg-title">ğŸ“ˆ Reports & Analytics</h1></div>
<div class="field-row" style="margin-bottom:24px">
<div class="field"><label class="field-label">From</label><input type="date" class="field-input" id="repFrom" onchange="rReports()"></div>
<div class="field"><label class="field-label">To</label><input type="date" class="field-input" id="repTo" onchange="rReports()"></div>
</div>
<div class="report-grid">
<div class="report-card"><h4>ğŸ’° Total Sales</h4><div class="value" id="repSales">GHS 0</div></div>
<div class="report-card"><h4>ğŸ’µ Total Profit</h4><div class="value success" id="repProfit">GHS 0</div></div>
<div class="report-card"><h4>ğŸ’¸ Expenses</h4><div class="value danger" id="repExp">GHS 0</div></div>
<div class="report-card"><h4>ğŸ“Š Net Profit</h4><div class="value" id="repNet">GHS 0</div></div>
</div>
<div class="card" style="margin-top:20px"><div class="card-title">ğŸ† Top Products</div><div id="topProducts"></div></div>
</section>

<!-- STAFF -->
<section class="pg" id="pgStaff">
<div class="pg-head-row"><div><h1 class="pg-title">ğŸ‘¤ Staff Management</h1></div><button class="btn btn-primary" onclick="openSfModal()">â• Add Staff</button></div>
<div class="card">
<div class="tbl-wrap"><table><thead><tr><th>Name</th><th>Role</th><th>Status</th><th>Actions</th></tr></thead><tbody id="sfTbl"></tbody></table></div>
</div>
</section>

</div></main>

<!-- CART DRAWER -->
<div id="cartBg" onclick="closeCart()"></div>
<div id="cartDrawer">
<div class="cart-bar"></div>
<div class="cart-head"><h3>ğŸ›’ Cart <span class="cart-count" id="cartCnt">0</span></h3><div class="action-btns"><button class="btn btn-danger btn-sm" onclick="clearCart()">ğŸ—‘ï¸ Clear</button></div></div>
<div class="cart-body" id="cartBody"><div class="cart-empty"><span>ğŸ›’</span><p>Your cart is empty</p></div></div>
<div class="cart-foot">
<div class="cart-summary">
<div class="cart-row"><span>Subtotal</span><b id="cartSub">GHS 0.00</b></div>
<div class="cart-row"><span>Discount</span><input type="number" class="disc-input" id="cartDisc" value="0" min="0" onchange="calcCart()"></div>
<div class="cart-row total"><span>Total</span><b id="cartTot">GHS 0.00</b></div>
</div>
<button class="cust-btn" id="custSelBtn" onclick="openSelCust()">ğŸ‘¥ Select Customer</button>
<input type="hidden" id="cartCustId">
<button class="checkout-btn" id="payBtn" onclick="openPayModal()" disabled>âœ“ Complete Sale</button>
</div>
</div>
</div>

<!-- MODALS -->
<div class="modal" id="payModal"><div class="modal-bg" onclick="closeMod('payModal')"></div><div class="modal-box"><div class="modal-head"><h3>ğŸ’³ Payment</h3><button class="modal-close" onclick="closeMod('payModal')">âœ•</button></div><div class="modal-body"><div class="field"><label class="field-label">Payment Method</label><select class="field-input" id="payMethod"><option value="cash">ğŸ’µ Cash</option><option value="momo">ğŸ“± Mobile Money</option><option value="card">ğŸ’³ Card</option></select></div><div class="hero" style="margin-top:20px"><small>Amount Due</small><strong id="payTotal">GHS 0</strong></div></div><div class="modal-foot"><button class="btn btn-success btn-full" onclick="completeSale()">âœ“ Confirm Payment</button></div></div></div>

<div class="modal" id="prModal"><div class="modal-bg" onclick="closeMod('prModal')"></div><div class="modal-box"><div class="modal-head"><h3 id="prModalTitle">Add Product</h3><button class="modal-close" onclick="closeMod('prModal')">âœ•</button></div><div class="modal-body"><input type="hidden" id="ePrId"><div class="img-upload"><div class="img-upload-area" id="imgUploadArea" onclick="$('prImgInput').click()"><div class="placeholder" id="imgPlaceholder"><span>ğŸ“·</span><p>Tap to upload image</p></div><img id="imgPreview" style="display:none"></div><input type="file" class="img-upload-input" id="prImgInput" accept="image/*" onchange="handleImg(this)"></div><div class="field"><label class="field-label">Name</label><input type="text" class="field-input" id="prName"></div><div class="field"><label class="field-label">Category</label><input type="text" class="field-input" id="prCat" placeholder="e.g. Electronics, Food"></div><div class="field-row"><div class="field"><label class="field-label">Cost Price</label><input type="number" class="field-input" id="prCost" min="0"></div><div class="field"><label class="field-label">Selling Price</label><input type="number" class="field-input" id="prPrice" min="0"></div></div><div class="field-row"><div class="field"><label class="field-label">Wholesale Price</label><input type="number" class="field-input" id="prWhole" min="0"></div><div class="field"><label class="field-label">Stock Qty</label><input type="number" class="field-input" id="prQty" min="0"></div></div></div><div class="modal-foot"><button class="btn btn-ghost" onclick="closeMod('prModal')">Cancel</button><button class="btn btn-primary" onclick="savePr()">ğŸ’¾ Save Product</button></div></div></div>

<div class="modal" id="bunModal"><div class="modal-bg" onclick="closeMod('bunModal')"></div><div class="modal-box"><div class="modal-head"><h3 id="bunModalTitle">Create Bundle</h3><button class="modal-close" onclick="closeMod('bunModal')">âœ•</button></div><div class="modal-body"><input type="hidden" id="eBunId"><div class="field"><label class="field-label">Bundle Name</label><input type="text" class="field-input" id="bunName" placeholder="e.g. Starter Pack"></div><div class="field"><label class="field-label">Bundle Price</label><input type="number" class="field-input" id="bunPrice" min="0"></div><div class="field"><label class="field-label">Select Products</label><div id="bunProds" style="max-height:200px;overflow-y:auto;background:#f8fafc;padding:12px;border-radius:12px"></div></div></div><div class="modal-foot"><button class="btn btn-ghost" onclick="closeMod('bunModal')">Cancel</button><button class="btn btn-primary" onclick="saveBun()">ğŸ’¾ Save Bundle</button></div></div></div>

<div class="modal" id="custModal"><div class="modal-bg" onclick="closeMod('custModal')"></div><div class="modal-box"><div class="modal-head"><h3 id="custModalTitle">Add Customer</h3><button class="modal-close" onclick="closeMod('custModal')">âœ•</button></div><div class="modal-body"><input type="hidden" id="eCustId"><div class="field"><label class="field-label">Name</label><input type="text" class="field-input" id="custName"></div><div class="field"><label class="field-label">Phone</label><input type="tel" class="field-input" id="custPhone"></div><div class="field"><label class="field-label">Address</label><textarea class="field-input" id="custAddr"></textarea></div></div><div class="modal-foot"><button class="btn btn-ghost" onclick="closeMod('custModal')">Cancel</button><button class="btn btn-primary" onclick="saveCust()">ğŸ’¾ Save</button></div></div></div>

<div class="modal" id="selCustModal"><div class="modal-bg" onclick="closeMod('selCustModal')"></div><div class="modal-box"><div class="modal-head"><h3>ğŸ‘¥ Select Customer</h3><button class="modal-close" onclick="closeMod('selCustModal')">âœ•</button></div><div class="modal-body"><input type="tel" class="field-input" placeholder="ğŸ” Search by phone..." id="selCustQ" oninput="rSelCust()" style="margin-bottom:16px"><div id="selCustList"></div></div><div class="modal-foot"><button class="btn btn-ghost" onclick="clearSelCust()">Clear Selection</button><button class="btn btn-primary" onclick="openCustModal();closeMod('selCustModal')">â• New</button></div></div></div>

<div class="modal" id="expModal"><div class="modal-bg" onclick="closeMod('expModal')"></div><div class="modal-box"><div class="modal-head"><h3>ğŸ’¸ Add Expense</h3><button class="modal-close" onclick="closeMod('expModal')">âœ•</button></div><div class="modal-body"><div class="field"><label class="field-label">Title</label><input type="text" class="field-input" id="expTitle" placeholder="What was this expense for?"></div><div class="field"><label class="field-label">Category</label><select class="field-input" id="expCat"><option value="utilities">âš¡ Utilities</option><option value="rent">ğŸ  Rent</option><option value="supplies">ğŸ“¦ Supplies</option><option value="transport">ğŸš— Transport</option><option value="salary">ğŸ‘¤ Salary</option><option value="other">ğŸ“ Other</option></select></div><div class="field"><label class="field-label">Amount (GHS)</label><input type="number" class="field-input" id="expAmt" min="0"></div></div><div class="modal-foot"><button class="btn btn-ghost" onclick="closeMod('expModal')">Cancel</button><button class="btn btn-danger" onclick="saveExp()">ğŸ’¸ Add Expense</button></div></div></div>

<div class="modal" id="sfModal"><div class="modal-bg" onclick="closeMod('sfModal')"></div><div class="modal-box"><div class="modal-head"><h3 id="sfModalTitle">Add Staff</h3><button class="modal-close" onclick="closeMod('sfModal')">âœ•</button></div><div class="modal-body"><input type="hidden" id="eSfId"><div class="field"><label class="field-label">Name</label><input type="text" class="field-input" id="sfName"></div><div class="field"><label class="field-label">Role</label><select class="field-input" id="sfRole"><option value="cashier">Cashier</option><option value="admin">Admin</option></select></div><div class="field"><label class="field-label">PIN (4 digits)</label><input type="tel" class="field-input" id="sfPin" maxlength="4" placeholder="e.g. 1234"></div></div><div class="modal-foot"><button class="btn btn-ghost" onclick="closeMod('sfModal')">Cancel</button><button class="btn btn-primary" onclick="saveSf()">ğŸ’¾ Save</button></div></div></div>

<div class="modal" id="rcptModal"><div class="modal-bg" onclick="closeMod('rcptModal')"></div><div class="modal-box"><div class="modal-head"><h3>ğŸ§¾ Receipt</h3><button class="modal-close" onclick="closeMod('rcptModal')">âœ•</button></div><div class="modal-body" id="rcptBody"></div><div class="modal-foot"><button class="btn btn-ghost" onclick="closeMod('rcptModal')">Close</button><button class="btn btn-primary" onclick="printRcpt()">ğŸ–¨ï¸ Print</button></div></div></div>

<div class="modal" id="stModal"><div class="modal-bg" onclick="closeMod('stModal')"></div><div class="modal-box" style="max-height:95vh"><div class="modal-head"><h3>ğŸ“‹ Stock Take</h3><button class="modal-close" onclick="closeMod('stModal')">âœ•</button></div><div class="modal-body"><input type="text" class="field-input" placeholder="ğŸ” Search..." id="stQ" oninput="filterStockItems()" style="margin-bottom:16px"><div id="stItems"></div></div><div class="modal-foot"><button class="btn btn-ghost" onclick="closeMod('stModal')">Cancel</button><button class="btn btn-success" onclick="saveStockTake()">âœ… Save Stock Take</button></div></div></div>

<div id="printArea"></div>
'').toLowerCase();
  const f=customers.filter(c=>(c.phone||'').includes(q)||(c.name||'').toLowerCase().includes(q));
  $('selCustList').innerHTML=f.length?f.map(c=>'<div class="cust-item" onclick="pickCust(\''+c.id+'\')"><div class="cust-avatar">'+c.name.charAt(0)+'</div><div class="cust-info"><div class="cust-name">'+c.name+'</div><div class="cust-phone">ğŸ“± '+(c.phone||'-')+'</div></div></div>').join(''):'<div class="tbl-empty"><span>ğŸ‘¥</span><p>No customers found</p></div>';
}
function pickCust(id){const c=customers.find(x=>x.id===id);if(!c)return;selCust=c;$('cartCustId').value=c.id;$('custSelBtn').textContent='ğŸ‘¤ '+c.name;$('custSelBtn').classList.add('sel');closeMod('selCustModal');toast(c.name+' selected','success')}
function clearSelCust(){selCust=null;$('cartCustId').value='';$('custSelBtn').textContent='ğŸ‘¥ Select Customer';$('custSelBtn').classList.remove('sel');closeMod('selCustModal')}
function openPayModal(){if(!cart.length)return;$('payMethod').value='cash';$('payTotal').textContent=m(cart.reduce((a,c)=>a+c.total,0)-n($('cartDisc').value));openMod('payModal')}
async function completeSale(){
  show('Processing sale...');
  const disc=n($('cartDisc').value),sub=cart.reduce((a,c)=>a+c.total,0),tot=sub-disc;
  const profit=cart.reduce((a,c)=>a+(c.price-c.cost)*c.qty,0)-disc;
  const rcNo='ER-'+Date.now().toString(36).toUpperCase();
  const{data:sale,error}=await db.from('sales').insert({shop_id:shop.id,user_id:user.id,receipt_no:rcNo,customer_id:selCust?.id,customer_name:selCust?.name,customer_phone:selCust?.phone,subtotal:sub,discount:disc,total:tot,profit:profit,payment_method:$('payMethod').value,sale_type:mode}).select().single();
  if(error){hide();toast('Error saving sale','error');return}
  const items=cart.map(c=>({sale_id:sale.id,product_id:c.pid||null,bundle_id:c.bid||null,name:c.name,quantity:c.qty,unit_price:c.price,cost_price:c.cost,line_total:c.total}));
  await db.from('sale_items').insert(items);
  for(const c of cart)if(c.pid)await db.rpc('update_stock',{p_product_id:c.pid,p_quantity:-c.qty});
  hide();toast('Sale completed! '+rcNo,'success');
  curRcpt={...sale,sale_items:items};
  cart=[];selCust=null;$('cartCustId').value='';$('custSelBtn').textContent='ğŸ‘¥ Select Customer';$('custSelBtn').classList.remove('sel');$('cartDisc').value=0;
  rCart();closeMod('payModal');closeCart();
  if(confirm('Print receipt?'))printTherm(curRcpt);
  await loadAll();
}

// ============================================================================
// RECEIPTS & PRINTING
// ============================================================================
function rReceipts(){
  const q=($('rcQ')?.value||'').toLowerCase();
  $('rcTbl').innerHTML=sales.filter(s=>s.receipt_no.toLowerCase().includes(q)||(s.customer_name||'').toLowerCase().includes(q)).slice(0,50).map(s=>'<tr><td><b style="color:var(--primary)">'+s.receipt_no+'</b></td><td>'+fmtD(s.created_at)+'</td><td>'+(s.customer_name||'Walk-in')+'</td><td><span class="badge badge-'+(s.sale_type==='whatsapp'?'whatsapp':s.sale_type==='wholesale'?'warning':'success')+'">'+s.sale_type+'</span></td><td><b>'+m(s.total)+'</b></td><td><div class="action-btns"><button class="btn btn-ghost btn-sm" onclick="viewRcpt(\''+s.id+'\')">ğŸ‘ï¸</button><button class="btn btn-primary btn-sm" onclick="printById(\''+s.id+'\')">ğŸ–¨ï¸</button></div></td></tr>').join('')||'<tr><td colspan="6"><div class="tbl-empty"><span>ğŸ§¾</span><p>No receipts</p></div></td></tr>';
}
function viewRcpt(id){const s=sales.find(x=>x.id===id);if(s)showRcpt(s)}
function printById(id){const s=sales.find(x=>x.id===id);if(s)printTherm(s)}
function showRcpt(s){curRcpt=s;$('rcptBody').innerHTML=genTherm(s);openMod('rcptModal')}
function printRcpt(){if(curRcpt)printTherm(curRcpt)}
function genTherm(s){
  const items=s.sale_items||[];const d=new Date(s.created_at);
  return '<div style="font-family:Courier,monospace;font-size:12px;max-width:280px;margin:0 auto;text-align:center"><div style="border-bottom:2px dashed #000;padding-bottom:12px;margin-bottom:12px"><b style="font-size:16px">'+SHOP.name+'</b><br><span style="font-size:10px">'+SHOP.tag+'</span><br><span style="font-size:10px">Tel: '+SHOP.ph1+' / '+SHOP.ph2+'</span><br><span style="font-size:10px">'+SHOP.addr+'</span></div><div style="text-align:left;margin-bottom:12px"><div style="display:flex;justify-content:space-between"><span>Receipt:</span><span><b>'+s.receipt_no+'</b></span></div><div style="display:flex;justify-content:space-between"><span>Date:</span><span>'+d.toLocaleDateString('en-GB')+' '+d.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'})+'</span></div><div style="display:flex;justify-content:space-between"><span>Cashier:</span><span>'+user?.name+'</span></div>'+(s.customer_name?'<div style="display:flex;justify-content:space-between"><span>Customer:</span><span>'+s.customer_name+'</span></div>':'')+'</div><div style="border-top:1px dashed #000;border-bottom:1px dashed #000;padding:12px 0;margin:12px 0;text-align:left">'+items.map(i=>'<div style="margin-bottom:8px"><div><b>'+i.name+'</b></div><div style="display:flex;justify-content:space-between;font-size:11px;padding-left:8px"><span>'+i.quantity+' x '+m(i.unit_price)+'</span><span>'+m(i.line_total)+'</span></div></div>').join('')+'</div><div style="text-align:left;margin-bottom:12px"><div style="display:flex;justify-content:space-between"><span>Subtotal:</span><span>'+m(s.subtotal)+'</span></div>'+(n(s.discount)>0?'<div style="display:flex;justify-content:space-between"><span>Discount:</span><span>-'+m(s.discount)+'</span></div>':'')+'<div style="display:flex;justify-content:space-between;font-size:16px;font-weight:bold;border-top:2px solid #000;padding-top:8px;margin-top:8px"><span>TOTAL:</span><span>'+m(s.total)+'</span></div><div style="display:flex;justify-content:space-between;margin-top:8px"><span>Payment:</span><span>'+(s.payment_method||'Cash').toUpperCase()+'</span></div></div><div style="border-top:1px dashed #000;padding-top:12px;font-size:10px"><p style="margin:4px 0">Thank you for shopping with us!</p><p style="margin:4px 0">'+SHOP.web+'</p></div></div>';
}
function printTherm(s){$('printArea').innerHTML=genTherm(s);setTimeout(()=>window.print(),200)}

// ============================================================================
// PRODUCTS
// ============================================================================
function rProducts(){
  const q=($('prQ')?.value||'').toLowerCase();
  $('prTbl').innerHTML=products.filter(p=>p.name.toLowerCase().includes(q)).map(p=>{
    const qt=n(p.quantity);const img=p.image_url?'<img src="'+p.image_url+'" style="width:50px;height:50px;object-fit:cover;border-radius:10px">':'ğŸ“¦';
    return '<tr><td>'+img+'</td><td><b>'+p.name+'</b><br><small style="color:#94a3b8">'+(p.category||'Uncategorized')+'</small></td><td style="color:var(--primary);font-weight:700">'+m(p.price)+'</td><td style="font-weight:700;color:'+(qt===0?'var(--danger)':qt<=5?'var(--warning)':'inherit')+'">'+qt+'</td><td><div class="action-btns"><button class="btn btn-ghost btn-sm" onclick="editPr(\''+p.id+'\')">âœï¸</button><button class="btn btn-danger btn-sm" onclick="delPr(\''+p.id+'\')">ğŸ—‘ï¸</button></div></td></tr>';
  }).join('')||'<tr><td colspan="5"><div class="tbl-empty"><span>ğŸ“¦</span><p>No products</p></div></td></tr>';
}
function handleImg(inp){if(inp.files&&inp.files[0]){const r=new FileReader();r.onload=e=>{curImg=e.target.result;$('imgPreview').src=curImg;$('imgPreview').style.display='block';$('imgPlaceholder').style.display='none';$('imgUploadArea').classList.add('has-img')};r.readAsDataURL(inp.files[0])}}
function openPrModal(){$('prModalTitle').textContent='Add Product';$('ePrId').value='';$('prName').value='';$('prCat').value='';$('prCost').value='';$('prPrice').value='';$('prWhole').value='';$('prQty').value='';curImg='';$('imgPreview').style.display='none';$('imgPlaceholder').style.display='flex';$('imgUploadArea').classList.remove('has-img');openMod('prModal')}
function editPr(id){
  const p=products.find(x=>x.id===id);if(!p)return;
  $('prModalTitle').textContent='Edit Product';$('ePrId').value=p.id;$('prName').value=p.name;$('prCat').value=p.category||'';$('prCost').value=p.cost_price;$('prPrice').value=p.price;$('prWhole').value=p.wholesale_price||'';$('prQty').value=p.quantity;
  if(p.image_url){curImg=p.image_url;$('imgPreview').src=p.image_url;$('imgPreview').style.display='block';$('imgPlaceholder').style.display='none';$('imgUploadArea').classList.add('has-img')}else{curImg='';$('imgPreview').style.display='none';$('imgPlaceholder').style.display='flex';$('imgUploadArea').classList.remove('has-img')}
  openMod('prModal');
}
async function savePr(){
  const id=$('ePrId').value,data={shop_id:shop.id,name:$('prName').value.trim(),category:$('prCat').value.trim()||null,cost_price:n($('prCost').value),price:n($('prPrice').value),wholesale_price:n($('prWhole').value),quantity:n($('prQty').value),image_url:curImg||null};
  if(!data.name||!data.price){toast('Name & Price required','error');return}
  show('Saving...');
  if(id)await db.from('products').update(data).eq('id',id);else await db.from('products').insert(data);
  hide();toast('Product saved!','success');closeMod('prModal');await loadProducts();rProducts();rPOS();rCategories();
}
async function delPr(id){if(!confirm('Delete product?'))return;show('Deleting...');await db.from('products').update({active:false}).eq('id',id);hide();toast('Deleted!','success');await loadProducts();rProducts();rPOS()}

// ============================================================================
// BUNDLES
// ============================================================================
function rBundles(){
  $('bunTbl').innerHTML=bundles.length?bundles.map(b=>{
    const items=b.bundle_items||[];const prodNames=items.map(i=>i.products?.name||'?').join(', ');
    const retailTotal=items.reduce((a,i)=>a+n(i.products?.price||0)*n(i.quantity),0);const savings=retailTotal-n(b.bundle_price);
    return '<tr><td><b>ğŸ '+b.name+'</b></td><td><small style="color:#64748b">'+prodNames+'</small></td><td style="color:var(--primary);font-weight:700">'+m(b.bundle_price)+'</td><td style="color:var(--success);font-weight:600">'+(savings>0?'Save '+m(savings):'-')+'</td><td><div class="action-btns"><button class="btn btn-ghost btn-sm" onclick="editBun(\''+b.id+'\')">âœï¸</button><button class="btn btn-danger btn-sm" onclick="delBun(\''+b.id+'\')">ğŸ—‘ï¸</button></div></td></tr>';
  }).join(''):'<tr><td colspan="5"><div class="tbl-empty"><span>ğŸ</span><p>No bundles</p></div></td></tr>';
}
function openBunModal(){$('bunModalTitle').textContent='Create Bundle';$('eBunId').value='';$('bunName').value='';$('bunPrice').value='';$('bunProds').innerHTML=products.map(p=>'<label style="display:flex;align-items:center;gap:10px;padding:10px;cursor:pointer"><input type="checkbox" class="bp-chk" data-id="'+p.id+'"><span style="flex:1">'+p.name+'</span><span style="color:var(--primary);font-weight:600">'+m(p.price)+'</span></label>').join('');openMod('bunModal')}
function editBun(id){
  const b=bundles.find(x=>x.id===id);if(!b)return;
  $('bunModalTitle').textContent='Edit Bundle';$('eBunId').value=b.id;$('bunName').value=b.name;$('bunPrice').value=b.bundle_price;
  const sel=(b.bundle_items||[]).map(i=>i.product_id);
  $('bunProds').innerHTML=products.map(p=>'<label style="display:flex;align-items:center;gap:10px;padding:10px;cursor:pointer"><input type="checkbox" class="bp-chk" data-id="'+p.id+'" '+(sel.includes(p.id)?'checked':'')+'><span style="flex:1">'+p.name+'</span><span style="color:var(--primary);font-weight:600">'+m(p.price)+'</span></label>').join('');
  openMod('bunModal');
}
async function saveBun(){
  const id=$('eBunId').value,name=$('bunName').value.trim(),price=n($('bunPrice').value);
  if(!name||!price){toast('Name & Price required','error');return}
  const prods=Array.from(document.querySelectorAll('.bp-chk:checked')).map(c=>c.dataset.id);
  if(!prods.length){toast('Select products','error');return}
  show('Saving...');let bid=id;
  if(id){await db.from('bundles').update({name,bundle_price:price}).eq('id',id);await db.from('bundle_items').delete().eq('bundle_id',id)}
  else{const{data}=await db.from('bundles').insert({shop_id:shop.id,name,bundle_price:price}).select().single();bid=data?.id}
  if(bid)await db.from('bundle_items').insert(prods.map(pid=>({bundle_id:bid,product_id:pid,quantity:1})));
  hide();toast('Bundle saved!','success');closeMod('bunModal');await loadBundles();rBundles();rPOS();
}
async function delBun(id){if(!confirm('Delete bundle?'))return;show('Deleting...');await db.from('bundles').update({active:false}).eq('id',id);hide();toast('Deleted!','success');await loadBundles();rBundles();rPOS()}

// ============================================================================
// CUSTOMERS
// ============================================================================
function rCustomers(){
  $('custTotal').textContent=customers.length;
  const totRev=customers.reduce((a,c)=>a+n(c.total_purchases),0);
  $('custRevenue').textContent=m(totRev);
  $('custAvg').textContent=customers.length?m(totRev/customers.length):'GHS 0';
  const q=($('custQ')?.value||'').toLowerCase();
  const f=customers.filter(c=>(c.phone||'').includes(q)||(c.name||'').toLowerCase().includes(q));
  $('custList').innerHTML=f.length?f.map(c=>'<div class="cust-item" onclick="editCust(\''+c.id+'\')"><div class="cust-avatar">'+c.name.charAt(0)+'</div><div class="cust-info"><div class="cust-name">'+c.name+'</div><div class="cust-phone">ğŸ“± '+(c.phone||'-')+'</div><div class="cust-stats"><div><span class="cust-stat-val">'+n(c.total_visits)+'</span> <span class="cust-stat-lbl">visits</span></div><div><span class="cust-stat-val">'+m(c.total_purchases)+'</span> <span class="cust-stat-lbl">spent</span></div></div></div></div>').join(''):'<div class="tbl-empty"><span>ğŸ‘¥</span><p>No customers</p></div>';
}
function openCustModal(){$('custModalTitle').textContent='Add Customer';$('eCustId').value='';$('custName').value='';$('custPhone').value='';$('custAddr').value='';openMod('custModal')}
function editCust(id){const c=customers.find(x=>x.id===id);if(!c)return;$('custModalTitle').textContent='Edit Customer';$('eCustId').value=c.id;$('custName').value=c.name;$('custPhone').value=c.phone||'';$('custAddr').value=c.address||'';openMod('custModal')}
async function saveCust(){
  const id=$('eCustId').value,data={shop_id:shop.id,name:$('custName').value.trim(),phone:$('custPhone').value.trim(),address:$('custAddr').value.trim()||null};
  if(!data.name||!data.phone){toast('Name & Phone required','error');return}
  show('Saving...');if(id)await db.from('customers').update(data).eq('id',id);else await db.from('customers').insert(data);
  hide();toast('Customer saved!','success');closeMod('custModal');await loadCustomers();rCustomers();
}

// ============================================================================
// EXPENSES
// ============================================================================
function rExpenses(){
  const mo=moS();let tot=0;for(const e of expenses)if(isoD(e.created_at)>=mo)tot+=n(e.amount);
  $('expMonth').textContent=m(tot);
  $('expList').innerHTML=expenses.length?expenses.slice(0,30).map(e=>'<div class="exp-item"><div class="exp-icon">'+catIcon(e.category)+'</div><div class="exp-info"><div class="exp-title">'+e.title+'</div><div class="exp-date">'+fmtD(e.created_at)+' â€¢ '+e.category+'</div></div><div class="exp-amt">-'+m(e.amount)+'</div><button class="btn btn-danger btn-sm" onclick="delExp(\''+e.id+'\')">ğŸ—‘ï¸</button></div>').join(''):'<div class="tbl-empty"><span>ğŸ’¸</span><p>No expenses</p></div>';
}
function openExpModal(){$('expTitle').value='';$('expCat').value='utilities';$('expAmt').value='';openMod('expModal')}
async function saveExp(){
  const title=$('expTitle').value.trim(),amt=n($('expAmt').value);
  if(!title||!amt){toast('Title & Amount required','error');return}
  show('Saving...');await db.from('expenses').insert({shop_id:shop.id,user_id:user.id,title,category:$('expCat').value,amount:amt});
  hide();toast('Expense added!','success');closeMod('expModal');await loadExpenses();rExpenses();rDash();
}
async function delExp(id){if(!confirm('Delete expense?'))return;show('Deleting...');await db.from('expenses').delete().eq('id',id);hide();toast('Deleted!','success');await loadExpenses();rExpenses();rDash()}

// ============================================================================
// STOCK TAKE
// ============================================================================
function rStockArea(){
  const active=stockTakes.find(st=>st.status==='in_progress');
  if(active){renderActiveStock(active)}
  else{$('stockArea').innerHTML='<div class="card" style="text-align:center;padding:40px"><span style="font-size:64px;opacity:.3">ğŸ“‹</span><p style="color:#64748b;margin:20px 0;font-size:16px">No active stock take</p><button class="btn btn-primary" onclick="startStockTake()">ğŸ“‹ Start New Stock Take</button></div>'}
}
async function startStockTake(){
  if(stockTakes.find(st=>st.status==='in_progress')){toast('Complete current stock take first','error');return}
  stItems=products.map(p=>({id:p.id,name:p.name,system:n(p.quantity),counted:n(p.quantity)}));
  $('stItems').innerHTML=stItems.map((it,i)=>'<div class="stock-item"><div class="stock-item-info"><div class="stock-item-name">'+it.name+'</div><div class="stock-item-current">System: '+it.system+'</div></div><input type="number" class="stock-item-input" value="'+it.counted+'" min="0" data-idx="'+i+'" onchange="updateStCount('+i+',this.value)"><div class="stock-var zero">0</div></div>').join('');
  openMod('stModal');
}
function filterStockItems(){
  const q=($('stQ')?.value||'').toLowerCase();
  document.querySelectorAll('#stItems .stock-item').forEach((el,i)=>{
    el.style.display=stItems[i].name.toLowerCase().includes(q)?'flex':'none';
  });
}
function updateStCount(idx,val){
  stItems[idx].counted=n(val);
  const variance=stItems[idx].counted-stItems[idx].system;
  const el=document.querySelectorAll('#stItems .stock-item')[idx];
  const varEl=el.querySelector('.stock-var');
  varEl.textContent=(variance>0?'+':'')+variance;
  varEl.className='stock-var '+(variance>0?'pos':variance<0?'neg':'zero');
  el.className='stock-item '+(variance>0?'pos':variance<0?'neg':'');
}
async function saveStockTake(){
  show('Saving stock take...');
  const ref='ST-'+Date.now().toString(36).toUpperCase();
  const{data:st}=await db.from('stock_takes').insert({shop_id:shop.id,user_id:user.id,reference_no:ref,status:'completed',total_items:stItems.length}).select().single();
  if(st){
    for(const it of stItems){
      const variance=it.counted-it.system;
      await db.from('stock_take_items').insert({stock_take_id:st.id,product_id:it.id,product_name:it.name,system_qty:it.system,counted_qty:it.counted,variance});
      if(variance!==0)await db.from('products').update({quantity:it.counted}).eq('id',it.id);
    }
  }
  hide();toast('Stock take saved! '+ref,'success');closeMod('stModal');await loadProducts();await loadStockTakes();rStockArea();rPOS();
}
function renderActiveStock(st){
  const items=st.stock_take_items||[];
  $('stockArea').innerHTML='<div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px"><div><b style="font-size:18px">ğŸ“‹ '+st.reference_no+'</b><div style="font-size:13px;color:#64748b;margin-top:4px">'+fmtDT(st.created_at)+'</div></div><span class="badge badge-warning">In Progress</span></div><div class="tbl-wrap"><table><thead><tr><th>Product</th><th>System</th><th>Counted</th><th>Variance</th></tr></thead><tbody>'+items.map(i=>{const v=n(i.variance);return '<tr><td><b>'+i.product_name+'</b></td><td>'+i.system_qty+'</td><td>'+i.counted_qty+'</td><td class="'+(v>0?'success':v<0?'danger':'')+'" style="font-weight:700">'+(v>0?'+':'')+v+'</td></tr>'}).join('')+'</tbody></table></div></div>';
}

// ============================================================================
// REPORTS
// ============================================================================
function initReports(){const t=new Date(),y=t.getFullYear(),mo=t.getMonth();$('repFrom').value=new Date(y,mo,1).toISOString().split('T')[0];$('repTo').value=t.toISOString().split('T')[0];rReports()}
function rReports(){
  const from=$('repFrom').value,to=$('repTo').value;let tS=0,tP=0;const ps={};
  for(const s of sales){if(s.status==='voided')continue;const d=isoD(s.created_at);if(d>=from&&d<=to){tS+=n(s.total);tP+=n(s.profit);for(const i of(s.sale_items||[])){if(!ps[i.name])ps[i.name]={qty:0,total:0};ps[i.name].qty+=i.quantity;ps[i.name].total+=n(i.line_total)}}}
  let tE=0;for(const e of expenses){const d=isoD(e.created_at);if(d>=from&&d<=to)tE+=n(e.amount)}
  const net=tP-tE;
  $('repSales').textContent=m(tS);$('repProfit').textContent=m(tP);$('repExp').textContent=m(tE);$('repNet').textContent=m(net);$('repNet').className='value '+(net>=0?'success':'danger');
  const top=Object.entries(ps).sort((a,b)=>b[1].total-a[1].total).slice(0,5);
  $('topProducts').innerHTML=top.length?top.map((p,i)=>'<div class="top-product"><div class="top-product-rank '+(i===0?'gold':i===1?'silver':i===2?'bronze':'')+'">'+(i+1)+'</div><div class="top-product-info"><div class="top-product-name">'+p[0]+'</div><div class="top-product-qty">'+p[1].qty+' sold</div></div><div class="top-product-total">'+m(p[1].total)+'</div></div>').join(''):'<div class="tbl-empty"><span>ğŸ“¦</span><p>No data for this period</p></div>';
}

// ============================================================================
// STAFF
// ============================================================================
function rStaff(){
  $('sfTbl').innerHTML=staff.map(s=>'<tr><td><b>'+s.name+'</b></td><td><span class="badge badge-'+(s.role==='admin'?'primary':'success')+'">'+s.role+'</span></td><td><span class="badge badge-'+(s.active?'success':'danger')+'">'+(s.active?'Active':'Inactive')+'</span></td><td><div class="action-btns"><button class="btn btn-ghost btn-sm" onclick="editSf(\''+s.id+'\')">âœï¸</button><button class="btn btn-danger btn-sm" onclick="delSf(\''+s.id+'\')">ğŸ—‘ï¸</button></div></td></tr>').join('')||'<tr><td colspan="4"><div class="tbl-empty"><span>ğŸ‘¤</span><p>No staff</p></div></td></tr>';
}
function openSfModal(){$('sfModalTitle').textContent='Add Staff';$('eSfId').value='';$('sfName').value='';$('sfRole').value='cashier';$('sfPin').value='';openMod('sfModal')}
function editSf(id){const s=staff.find(x=>x.id===id);if(!s)return;$('sfModalTitle').textContent='Edit Staff';$('eSfId').value=s.id;$('sfName').value=s.name;$('sfRole').value=s.role;$('sfPin').value=s.pin;openMod('sfModal')}
async function saveSf(){
  const id=$('eSfId').value,data={shop_id:shop.id,name:$('sfName').value.trim(),role:$('sfRole').value,pin:$('sfPin').value.trim(),active:true};
  if(!data.name||data.pin.length!==4){toast('Name & 4-digit PIN required','error');return}
  show('Saving...');if(id)await db.from('users').update(data).eq('id',id);else await db.from('users').insert(data);
  hide();toast('Staff saved!','success');closeMod('sfModal');await loadStaff();rStaff();
}
async function delSf(id){if(!confirm('Delete staff?'))return;show('Deleting...');await db.from('users').update({active:false}).eq('id',id);hide();toast('Deleted!','success');await loadStaff();rStaff()}

// ============================================================================
// INIT
// ============================================================================
document.addEventListener('DOMContentLoaded',init);
</script>
</body>
</html>
