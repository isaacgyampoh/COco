<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0d9488">
<title>Everytin Room POS</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Poppins',sans-serif;background:linear-gradient(135deg,#f0fdfa,#ccfbf1,#fef3c7);min-height:100vh;color:#134e4a}
:root{--p:#0d9488;--a:#f59e0b;--s:#22c55e;--d:#ef4444;--g:linear-gradient(135deg,#0d9488,#14b8a6,#f59e0b)}
#loader{position:fixed;inset:0;background:var(--g);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px}
#loader.hide{display:none}
#loader h1{font-size:26px;color:#fff}
#loader h1 span{color:#fbbf24}
#loader .spin{width:40px;height:40px;border:4px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
#loader p{color:#fff;font-size:13px}
#toast{position:fixed;top:80px;left:50%;transform:translateX(-50%);background:#134e4a;color:#fff;padding:12px 24px;border-radius:30px;font-size:13px;font-weight:600;z-index:9999;display:none}
#toast.show{display:block}
#toast.ok{background:var(--s)}
#toast.err{background:var(--d)}
#login{position:fixed;inset:0;background:var(--g);display:flex;align-items:center;justify-content:center;padding:20px;z-index:1000}
#login.hide{display:none}
.login-box{text-align:center;max-width:320px;width:100%}
.login-box h1{font-size:26px;color:#fff;margin-bottom:4px}
.login-box h1 span{color:#fbbf24}
.login-box>p{color:rgba(255,255,255,.8);font-size:12px;margin-bottom:24px}
.login-card{background:#fff;border-radius:20px;padding:28px 24px}
.login-card h2{font-size:18px;font-weight:700;margin-bottom:4px}
.login-card>p{color:#64748b;font-size:11px;margin-bottom:20px}
.pins{display:flex;gap:10px;justify-content:center}
.pin-input{width:48px;height:54px;border:3px solid #e2e8f0;border-radius:12px;font-size:22px;font-weight:700;text-align:center;background:#f8fafc}
.pin-input:focus{outline:none;border-color:var(--p);background:#fff}
#pin-err{background:#fef2f2;color:#dc2626;padding:10px;border-radius:8px;margin-top:14px;font-size:11px;display:none}
#app{display:none}
#app.show{display:block}
.header{position:fixed;top:0;left:0;right:0;height:54px;background:rgba(255,255,255,.95);backdrop-filter:blur(10px);display:flex;align-items:center;padding:0 14px;gap:8px;z-index:100;border-bottom:1px solid rgba(0,0,0,.05)}
.header-logo{display:flex;align-items:center;gap:8px;font-size:14px;font-weight:800;flex:1}
.header-logo span{color:var(--a)}
.header-logo .icon{width:32px;height:32px;background:var(--g);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px}
.header-btn{width:36px;height:36px;border-radius:10px;background:rgba(13,148,136,.08);display:flex;align-items:center;justify-content:center;font-size:15px;border:none;cursor:pointer;position:relative}
.badge{position:absolute;top:0;right:0;min-width:16px;height:16px;background:var(--d);border-radius:8px;font-size:9px;font-weight:700;color:#fff;display:flex;align-items:center;justify-content:center}
.realtime{width:8px;height:8px;background:var(--s);border-radius:50%;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.nav{position:fixed;bottom:0;left:0;right:0;background:rgba(255,255,255,.95);backdrop-filter:blur(10px);display:flex;padding:6px 10px calc(6px + env(safe-area-inset-bottom));z-index:100;border-top:1px solid rgba(0,0,0,.05)}
.nav-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;padding:5px;border-radius:10px;font-size:8px;font-weight:600;color:#94a3b8;border:none;background:none;cursor:pointer}
.nav-btn span{font-size:18px}
.nav-btn.on{color:var(--p);background:rgba(13,148,136,.1)}
.fab{position:fixed;bottom:calc(65px + env(safe-area-inset-bottom));right:14px;width:52px;height:52px;background:var(--g);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:22px;color:#fff;z-index:99;box-shadow:0 4px 20px rgba(13,148,136,.4);border:none;cursor:pointer}
.fab .badge{top:-4px;right:-4px;min-width:20px;height:20px;background:var(--a);border:2px solid #fff}
.main{padding:62px 14px calc(70px + env(safe-area-inset-bottom))}
.page{display:none}
.page.on{display:block}
.page-title{font-size:18px;font-weight:800;margin-bottom:14px}
.page-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.stats{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px}
.stat{background:#fff;border-radius:12px;padding:12px;box-shadow:0 2px 10px rgba(0,0,0,.04)}
.stat-icon{font-size:22px;margin-bottom:4px}
.stat-label{font-size:8px;font-weight:600;color:#94a3b8;text-transform:uppercase}
.stat-value{font-size:16px;font-weight:800;margin-top:2px}
.card{background:#fff;border-radius:12px;padding:12px;margin-bottom:10px;box-shadow:0 2px 10px rgba(0,0,0,.04)}
.card-title{font-size:12px;font-weight:700;margin-bottom:10px}
.btn{height:36px;padding:0 12px;border-radius:10px;font-size:11px;font-weight:600;border:none;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:5px}
.btn-p{background:var(--g);color:#fff}
.btn-s{background:var(--s);color:#fff}
.btn-d{background:var(--d);color:#fff}
.btn-w{background:var(--a);color:#fff}
.btn-g{background:rgba(13,148,136,.08);color:#134e4a}
.btn-sm{height:30px;padding:0 8px;font-size:10px}
.btn-full{width:100%}
.input{width:100%;height:40px;padding:0 12px;background:#f8fafc;border:2px solid #e2e8f0;border-radius:10px;font-size:13px;font-family:inherit}
.input:focus{outline:none;border-color:var(--p)}
textarea.input{height:70px;padding:10px;resize:none}
.field{margin-bottom:10px}
.field-label{display:block;font-size:9px;font-weight:600;color:#64748b;margin-bottom:4px;text-transform:uppercase}
.field-row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.products{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.product{background:#fff;border-radius:10px;padding:8px;cursor:pointer;box-shadow:0 2px 10px rgba(0,0,0,.04);border:2px solid transparent}
.product:active{border-color:var(--p)}
.product.out{opacity:.4;pointer-events:none}
.product-img{width:100%;height:55px;background:#f0fdfa;border-radius:8px;margin-bottom:5px;display:flex;align-items:center;justify-content:center;font-size:26px;overflow:hidden}
.product-img img{width:100%;height:100%;object-fit:cover}
.product-name{font-size:10px;font-weight:600;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.product-price{font-size:14px;font-weight:800;color:var(--p)}
.product-stock{display:inline-block;padding:2px 5px;border-radius:8px;font-size:7px;font-weight:700;margin-top:3px}
.product-stock.ok{background:rgba(34,197,94,.1);color:var(--s)}
.product-stock.low{background:rgba(245,158,11,.1);color:var(--a)}
.product-stock.out{background:rgba(239,68,68,.1);color:var(--d)}
.cats{display:flex;gap:5px;overflow-x:auto;margin-bottom:10px;padding-bottom:4px}
.cat{height:28px;padding:0 10px;background:#fff;border:2px solid #e2e8f0;border-radius:14px;font-size:10px;font-weight:600;color:#64748b;white-space:nowrap;cursor:pointer;display:flex;align-items:center}
.cat.on{background:var(--p);color:#fff;border-color:transparent}
.modes{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:12px}
.mode{height:44px;background:#fff;border:2px solid #e2e8f0;border-radius:10px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1px;font-size:8px;font-weight:700;color:#94a3b8;cursor:pointer}
.mode span{font-size:16px}
.mode.on{border-color:var(--p);color:var(--p)}
.mode.wh.on{border-color:var(--a);color:var(--a)}
.mode.bu.on{border-color:#8b5cf6;color:#8b5cf6}
#cartBg{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:300;display:none}
#cartBg.on{display:block}
#cart{position:fixed;bottom:0;left:0;right:0;background:#fff;border-radius:18px 18px 0 0;max-height:80vh;z-index:301;transform:translateY(100%);transition:.3s;display:flex;flex-direction:column}
#cart.on{transform:translateY(0)}
.cart-bar{width:36px;height:4px;background:#e2e8f0;border-radius:2px;margin:10px auto}
.cart-head{display:flex;align-items:center;justify-content:space-between;padding:0 14px 10px;border-bottom:1px solid #f1f5f9}
.cart-head h3{font-size:14px;font-weight:800}
.cart-body{flex:1;overflow-y:auto;padding:10px 14px;max-height:32vh}
.cart-item{display:flex;align-items:center;gap:6px;padding:8px;background:#f8fafc;border-radius:10px;margin-bottom:5px}
.cart-item-img{width:34px;height:34px;background:#f0fdfa;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:14px;overflow:hidden;flex-shrink:0}
.cart-item-img img{width:100%;height:100%;object-fit:cover}
.cart-item-info{flex:1;min-width:0}
.cart-item-name{font-size:10px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cart-item-price{font-size:9px;color:#64748b}
.cart-qty{display:flex;align-items:center;gap:3px}
.cart-qty-btn{width:24px;height:24px;border-radius:6px;background:#fff;border:2px solid #e2e8f0;font-size:12px;cursor:pointer}
.cart-qty-num{font-size:11px;font-weight:700;min-width:16px;text-align:center}
.cart-item-total{font-size:11px;font-weight:700;color:var(--p)}
.cart-item-del{width:24px;height:24px;border-radius:6px;background:rgba(239,68,68,.1);color:var(--d);font-size:10px;border:none;cursor:pointer;flex-shrink:0}
.cart-empty{text-align:center;padding:20px;color:#94a3b8}
.cart-empty span{font-size:36px;display:block;margin-bottom:6px;opacity:.3}
.cart-foot{padding:10px 14px calc(10px + env(safe-area-inset-bottom));border-top:1px solid #f1f5f9;background:#fafafa}
.cart-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;font-size:11px;color:#64748b}
.cart-row b{color:#134e4a}
.cart-row.tot{font-size:14px;font-weight:800;padding-top:8px;border-top:2px dashed #e2e8f0}
.cart-row.tot b{color:var(--p)}
.disc-inp{width:50px;height:26px;padding:0 6px;background:#fff;border:2px solid #e2e8f0;border-radius:6px;font-size:10px;font-weight:600;text-align:right}
.cust-btn{width:100%;height:34px;background:rgba(13,148,136,.05);border:2px dashed rgba(13,148,136,.3);border-radius:8px;font-size:11px;font-weight:600;color:var(--p);cursor:pointer;margin-bottom:8px;display:flex;align-items:center;justify-content:center;gap:5px}
.cust-btn.sel{background:rgba(13,148,136,.1);border-style:solid}
.pay-btn{width:100%;height:44px;background:var(--g);border-radius:10px;color:#fff;font-size:13px;font-weight:700;border:none;cursor:pointer}
.pay-btn:disabled{opacity:.5}
.modal{position:fixed;inset:0;z-index:400;display:none;align-items:flex-end;justify-content:center}
.modal.on{display:flex}
.modal-bg{position:absolute;inset:0;background:rgba(0,0,0,.4)}
.modal-box{position:relative;background:#fff;border-radius:18px 18px 0 0;width:100%;max-height:82vh;display:flex;flex-direction:column}
.modal-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #f1f5f9}
.modal-head h3{font-size:14px;font-weight:700}
.modal-close{width:30px;height:30px;background:#f1f5f9;border-radius:8px;font-size:14px;border:none;cursor:pointer}
.modal-body{flex:1;overflow-y:auto;padding:14px}
.modal-foot{padding:10px 14px calc(10px + env(safe-area-inset-bottom));border-top:1px solid #f1f5f9;display:flex;gap:6px}
table{width:100%;border-collapse:collapse}
th{text-align:left;padding:7px 6px;background:#f8fafc;font-size:8px;font-weight:700;color:#64748b;text-transform:uppercase}
td{padding:7px 6px;border-bottom:1px solid #f1f5f9;font-size:10px}
.empty{text-align:center;padding:20px;color:#94a3b8}
.empty span{font-size:32px;display:block;margin-bottom:6px;opacity:.3}
.tabs{display:flex;gap:5px;overflow-x:auto;margin-bottom:12px}
.tab{height:32px;padding:0 12px;background:#fff;border:2px solid #e2e8f0;border-radius:8px;font-size:10px;font-weight:600;color:#64748b;white-space:nowrap;cursor:pointer}
.tab.on{background:var(--p);color:#fff;border-color:transparent}
.hero{background:var(--g);border-radius:12px;padding:14px;color:#fff;margin-bottom:12px}
.hero.d{background:var(--d)}
.hero small{font-size:10px;opacity:.9}
.hero strong{display:block;font-size:22px;font-weight:800;margin-top:3px}
.top-item{display:flex;align-items:center;gap:8px;padding:8px;background:#f8fafc;border-radius:8px;margin-bottom:5px}
.top-rank{width:20px;height:20px;background:var(--g);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:9px}
.top-info{flex:1}
.top-name{font-weight:600;font-size:11px}
.top-qty{font-size:9px;color:#64748b}
.top-total{font-weight:700;color:var(--p);font-size:11px}
.exp-item{display:flex;align-items:center;gap:8px;padding:8px;background:#f8fafc;border-radius:8px;margin-bottom:5px}
.exp-icon{width:32px;height:32px;background:rgba(239,68,68,.1);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px}
.exp-info{flex:1}
.exp-title{font-weight:600;font-size:11px}
.exp-date{font-size:9px;color:#64748b}
.exp-amt{font-weight:700;color:var(--d);font-size:11px}
.cust-item{background:#fff;border-radius:10px;padding:10px;box-shadow:0 2px 10px rgba(0,0,0,.04);margin-bottom:8px;display:flex;align-items:center;gap:10px;cursor:pointer}
.cust-avatar{width:40px;height:40px;background:var(--g);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:16px;font-weight:700;flex-shrink:0}
.cust-info{flex:1;min-width:0}
.cust-name{font-size:13px;font-weight:700}
.cust-phone{font-size:10px;color:#64748b}
.cust-stats{display:flex;gap:12px;margin-top:4px}
.cust-stat-val{font-size:11px;font-weight:700;color:var(--p)}
.cust-stat-lbl{font-size:8px;color:#94a3b8}
.order-card{background:#fff;border-radius:12px;padding:12px;box-shadow:0 2px 10px rgba(0,0,0,.04);margin-bottom:8px;border-left:4px solid var(--p)}
.order-card.done{border-left-color:var(--s);opacity:.7}
.order-card.cancel{border-left-color:var(--d);opacity:.5}
.order-head{display:flex;justify-content:space-between;margin-bottom:6px}
.order-id{font-size:12px;font-weight:700}
.order-time{font-size:9px;color:#94a3b8}
.order-status{padding:3px 8px;border-radius:12px;font-size:8px;font-weight:700}
.order-status.pending{background:rgba(13,148,136,.1);color:var(--p)}
.order-status.completed{background:rgba(34,197,94,.1);color:var(--s)}
.order-status.cancelled{background:rgba(239,68,68,.1);color:var(--d)}
.order-cust{display:flex;align-items:center;gap:8px;padding:8px;background:#f8fafc;border-radius:8px;margin-bottom:8px}
.order-avatar{width:32px;height:32px;background:var(--g);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:14px}
.order-info h4{font-size:11px;font-weight:600}
.order-info p{font-size:9px;color:#64748b}
.order-item{display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px dashed #e2e8f0;font-size:10px}
.order-item:last-child{border-bottom:none}
.order-foot{display:flex;justify-content:space-between;align-items:center;padding-top:8px;border-top:2px solid #f1f5f9;margin-top:8px}
.order-total{font-size:16px;font-weight:800;color:var(--p)}
.stock-item{display:flex;align-items:center;gap:6px;padding:10px;background:#f8fafc;border-radius:10px;margin-bottom:5px;border-left:3px solid #e2e8f0}
.stock-item.pos{border-left-color:var(--s)}
.stock-item.neg{border-left-color:var(--d)}
.stock-info{flex:1;min-width:0}
.stock-name{font-weight:600;font-size:11px}
.stock-qty{display:flex;flex-direction:column;align-items:center;min-width:44px}
.stock-qty-lbl{font-size:7px;color:#94a3b8;text-transform:uppercase}
.stock-qty-val{font-size:14px;font-weight:700}
.stock-inp{width:55px;height:32px;text-align:center;font-size:13px;font-weight:700;border:2px solid #e2e8f0;border-radius:6px}
.stock-inp:focus{outline:none;border-color:var(--p)}
.stock-var{min-width:40px;text-align:center;font-weight:700;padding:4px;border-radius:6px;font-size:10px}
.stock-var.pos{background:rgba(34,197,94,.1);color:var(--s)}
.stock-var.neg{background:rgba(239,68,68,.1);color:var(--d)}
.stock-var.zero{background:#f1f5f9;color:#64748b}
.stock-sum{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:14px}
.stock-sum-card{background:#fff;border-radius:10px;padding:12px;text-align:center;box-shadow:0 2px 10px rgba(0,0,0,.04)}
.stock-sum-val{font-size:18px;font-weight:800}
.stock-sum-lbl{font-size:8px;color:#64748b;margin-top:2px}
.stock-prog{height:5px;background:#e2e8f0;border-radius:3px;overflow:hidden;margin:12px 0}
.stock-prog-bar{height:100%;background:var(--g);border-radius:3px}
.img-upload{width:100%;height:90px;background:#f0fdfa;border:2px dashed rgba(13,148,136,.3);border-radius:10px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;overflow:hidden;position:relative}
.img-upload img{width:100%;height:100%;object-fit:cover}
.img-upload span{font-size:28px;margin-bottom:2px}
.img-upload p{font-size:9px;color:#64748b}
.img-upload input{position:absolute;inset:0;opacity:0;cursor:pointer}
.acts{display:flex;gap:4px}
@media print{body *{visibility:hidden}#printArea,#printArea *{visibility:visible}#printArea{position:fixed;left:0;top:0;width:80mm;padding:3mm;background:#fff;font-family:'Courier New',monospace;font-size:11px}}
</style>
</head>
<body>
<div id="loader"><h1>Everytin <span>Room</span></h1><div class="spin"></div><p id="loadTxt">Loading...</p></div>
<div id="toast"></div>
<div id="login"><div class="login-box"><h1>Everytin <span>Room</span></h1><p>Your One Stop Shop</p><div class="login-card"><h2>Welcome!</h2><p>Enter your 4-digit PIN</p><div class="pins"><input type="tel" maxlength="1" class="pin-input" id="p1" oninput="pinIn(1)" inputmode="numeric"><input type="tel" maxlength="1" class="pin-input" id="p2" oninput="pinIn(2)" inputmode="numeric"><input type="tel" maxlength="1" class="pin-input" id="p3" oninput="pinIn(3)" inputmode="numeric"><input type="tel" maxlength="1" class="pin-input" id="p4" oninput="pinIn(4)" inputmode="numeric"></div><div id="pin-err">Invalid PIN</div></div></div></div>
<div id="app">
<header class="header"><div class="header-logo"><div class="icon">ğŸ›’</div>Everytin <span>Room</span></div><div class="realtime" title="Live"></div><button class="header-btn" onclick="goTo('orders')">ğŸ›ï¸<span class="badge" id="ordBadge">0</span></button><button class="header-btn" onclick="openMenu()">â˜°</button></header>
<button class="fab" onclick="openCart()">ğŸ›’<span class="badge" id="cartBadge">0</span></button>
<nav class="nav"><button class="nav-btn on" data-pg="pos" onclick="goTo('pos')"><span>ğŸ›’</span>POS</button><button class="nav-btn" data-pg="orders" onclick="goTo('orders')"><span>ğŸ›ï¸</span>Orders</button><button class="nav-btn" data-pg="receipts" onclick="goTo('receipts')"><span>ğŸ§¾</span>History</button><button class="nav-btn" data-pg="dash" onclick="goTo('dash')"><span>ğŸ“Š</span>More</button></nav>
<main class="main">
<section class="page on" id="pgPos"><h1 class="page-title">ğŸ›’ Point of Sale</h1><input type="text" class="input" placeholder="ğŸ” Search products..." id="posQ" oninput="renderPOS()" style="margin-bottom:10px"><div class="cats" id="catFilter"></div><div class="modes"><button class="mode on" id="mdRet" onclick="setMode('retail')"><span>ğŸ›ï¸</span>Retail</button><button class="mode wh" id="mdWho" onclick="setMode('wholesale')"><span>ğŸ­</span>Wholesale</button><button class="mode bu" id="mdBun" onclick="setMode('bundle')"><span>ğŸ</span>Bundle</button></div><div class="products" id="prodGrid"></div></section>
<section class="page" id="pgOrders"><div class="page-row"><h1 class="page-title" style="margin:0">ğŸ›ï¸ WhatsApp Orders</h1><button class="btn btn-g btn-sm" onclick="loadOrders().then(renderOrders)">ğŸ”„</button></div><div class="hero"><small>Pending Orders</small><strong id="pendCnt">0</strong></div><div class="tabs"><button class="tab on" onclick="setOrdFilter('pending')">Pending</button><button class="tab" onclick="setOrdFilter('completed')">Done</button><button class="tab" onclick="setOrdFilter('all')">All</button></div><div id="ordersList"></div></section>
<section class="page" id="pgReceipts"><h1 class="page-title">ğŸ§¾ Sales History</h1><div class="card"><input type="text" class="input" placeholder="ğŸ” Search receipt..." id="rcQ" oninput="renderReceipts()" style="margin-bottom:8px"><div style="overflow-x:auto"><table><thead><tr><th>Receipt</th><th>Date</th><th>Customer</th><th>Total</th><th></th></tr></thead><tbody id="rcTbl"></tbody></table></div></div></section>
<section class="page" id="pgDash"><h1 class="page-title">ğŸ“Š Dashboard</h1><div class="stats"><div class="stat"><div class="stat-icon">ğŸ’°</div><div class="stat-label">Today Sales</div><div class="stat-value" id="dSales">GHS 0</div></div><div class="stat"><div class="stat-icon">ğŸ’µ</div><div class="stat-label">Profit</div><div class="stat-value" id="dProfit">GHS 0</div></div><div class="stat"><div class="stat-icon">ğŸ›ï¸</div><div class="stat-label">Orders</div><div class="stat-value" id="dPend">0</div></div><div class="stat"><div class="stat-icon">ğŸ’¸</div><div class="stat-label">Expenses</div><div class="stat-value" id="dExp">GHS 0</div></div></div><div class="card"><div class="card-title">ğŸ† Top Selling Today</div><div id="topToday"></div></div></section>
<section class="page" id="pgProducts"><div class="page-row"><h1 class="page-title" style="margin:0">ğŸ“¦ Products</h1><button class="btn btn-p btn-sm" onclick="openProdModal()">â• Add</button></div><div class="card"><input type="text" class="input" placeholder="ğŸ” Search..." id="prQ" oninput="renderProducts()" style="margin-bottom:8px"><div style="overflow-x:auto"><table><thead><tr><th></th><th>Name</th><th>Price</th><th>Stock</th><th></th></tr></thead><tbody id="prTbl"></tbody></table></div></div></section>
<section class="page" id="pgBundles"><div class="page-row"><h1 class="page-title" style="margin:0">ğŸ Bundles</h1><button class="btn btn-p btn-sm" onclick="openBundleModal()">â• Add</button></div><div id="bundlesList"></div></section>
<section class="page" id="pgCustomers"><div class="page-row"><h1 class="page-title" style="margin:0">ğŸ‘¥ Customers</h1><button class="btn btn-p btn-sm" onclick="openCustModal()">â• Add</button></div><div class="stats" style="grid-template-columns:1fr 1fr 1fr"><div class="stat"><div class="stat-icon">ğŸ‘¥</div><div class="stat-label">Total</div><div class="stat-value" id="custTot">0</div></div><div class="stat"><div class="stat-icon">â­</div><div class="stat-label">Points</div><div class="stat-value" id="custPts">0</div></div><div class="stat"><div class="stat-icon">ğŸ’°</div><div class="stat-label">Revenue</div><div class="stat-value" id="custRev">GHS 0</div></div></div><div class="card"><input type="text" class="input" placeholder="ğŸ” Search phone..." id="custQ" oninput="renderCustomers()" style="margin-bottom:8px"><div id="custList"></div></div></section>
<section class="page" id="pgStock"><div class="page-row"><h1 class="page-title" style="margin:0">ğŸ“‹ Stock Take</h1><div class="acts"><button class="btn btn-g btn-sm" onclick="viewStockHist()">ğŸ“œ</button><button class="btn btn-p btn-sm" onclick="startStock()">â• New</button></div></div><div id="stockArea"></div></section>
<section class="page" id="pgExpenses"><div class="page-row"><h1 class="page-title" style="margin:0">ğŸ’¸ Expenses</h1><button class="btn btn-d btn-sm" onclick="openExpModal()">â• Add</button></div><div class="hero d"><small>This Month</small><strong id="expMonth">GHS 0</strong></div><div class="card"><div id="expList"></div></div></section>
<section class="page" id="pgReports"><h1 class="page-title">ğŸ“ˆ Reports</h1><div class="field-row" style="margin-bottom:12px"><div class="field"><label class="field-label">From</label><input type="date" class="input" id="repFrom" onchange="renderReports()"></div><div class="field"><label class="field-label">To</label><input type="date" class="input" id="repTo" onchange="renderReports()"></div></div><div class="stats"><div class="stat"><div class="stat-label">Sales</div><div class="stat-value" id="repSales">GHS 0</div></div><div class="stat"><div class="stat-label">Profit</div><div class="stat-value" id="repProfit" style="color:var(--s)">GHS 0</div></div><div class="stat"><div class="stat-label">Expenses</div><div class="stat-value" id="repExp" style="color:var(--d)">GHS 0</div></div><div class="stat"><div class="stat-label">Net</div><div class="stat-value" id="repNet">GHS 0</div></div></div><div class="card"><div class="card-title">ğŸ† Top Products</div><div id="topProdList"></div></div></section>
<section class="page" id="pgStaff"><div class="page-row"><h1 class="page-title" style="margin:0">ğŸ‘¤ Staff</h1><button class="btn btn-p btn-sm" onclick="openStaffModal()">â• Add</button></div><div class="card"><div style="overflow-x:auto"><table><thead><tr><th>Name</th><th>Role</th><th>Status</th><th></th></tr></thead><tbody id="sfTbl"></tbody></table></div></div></section>
</main>
<div id="cartBg" onclick="closeCart()"></div>
<div id="cart"><div class="cart-bar"></div><div class="cart-head"><h3>ğŸ›’ Cart <span id="cartCnt">0</span></h3><div class="acts"><button class="btn btn-w btn-sm" onclick="holdCart()">â¸ï¸</button><button class="btn btn-g btn-sm" onclick="openHeld()" id="heldBtn" style="display:none">ğŸ“‹<span id="heldCnt">0</span></button><button class="btn btn-d btn-sm" onclick="clearCart()">ğŸ—‘ï¸</button></div></div><div class="cart-body" id="cartBody"><div class="cart-empty"><span>ğŸ›’</span><p>Empty cart</p></div></div><div class="cart-foot"><div class="cart-row"><span>Subtotal</span><b id="cartSub">GHS 0</b></div><div class="cart-row"><span>Discount</span><input type="number" class="disc-inp" id="cartDisc" value="0" min="0" onchange="calcCart()"></div><div class="cart-row tot"><span>Total</span><b id="cartTot">GHS 0</b></div><button class="cust-btn" id="custSelBtn" onclick="openSelCust()">ğŸ‘¥ Select Customer</button><input type="hidden" id="cartCustId"><button class="pay-btn" id="payBtn" onclick="openPayModal()" disabled>âœ“ Checkout</button></div></div>
</div>
<div class="modal" id="payModal"><div class="modal-bg" onclick="closeMod('payModal')"></div><div class="modal-box"><div class="modal-head"><h3>ğŸ’³ Payment</h3><button class="modal-close" onclick="closeMod('payModal')">âœ•</button></div><div class="modal-body"><div class="field"><label class="field-label">Method</label><select class="input" id="payMethod"><option value="cash">ğŸ’µ Cash</option><option value="momo">ğŸ“± MoMo</option><option value="card">ğŸ’³ Card</option></select></div><div class="hero" style="margin-top:10px"><small>Total Due</small><strong id="payTotal">GHS 0</strong></div></div><div class="modal-foot"><button class="btn btn-p btn-full" onclick="completeSale()">âœ“ Confirm & Print</button></div></div></div>
<div class="modal" id="prModal"><div class="modal-bg" onclick="closeMod('prModal')"></div><div class="modal-box"><div class="modal-head"><h3 id="prModalTitle">Add Product</h3><button class="modal-close" onclick="closeMod('prModal')">âœ•</button></div><div class="modal-body"><input type="hidden" id="ePrId"><div class="field"><label class="field-label">Image</label><div class="img-upload" id="prImgUp"><span>ğŸ“·</span><p>Upload</p><input type="file" id="prImgIn" accept="image/*" onchange="prevImg(this)"></div></div><input type="hidden" id="prImgUrl"><div class="field"><label class="field-label">Name</label><input type="text" class="input" id="prName"></div><div class="field"><label class="field-label">Category</label><input type="text" class="input" id="prCat"></div><div class="field-row"><div class="field"><label class="field-label">Cost Price</label><input type="number" class="input" id="prCost" min="0" step="0.01"></div><div class="field"><label class="field-label">Selling Price</label><input type="number" class="input" id="prPrice" min="0" step="0.01"></div></div><div class="field-row"><div class="field"><label class="field-label">Wholesale</label><input type="number" class="input" id="prWhole" min="0" step="0.01"></div><div class="field"><label class="field-label">Stock Qty</label><input type="number" class="input" id="prQty" min="0"></div></div></div><div class="modal-foot"><button class="btn btn-g" onclick="closeMod('prModal')">Cancel</button><button class="btn btn-p" onclick="saveProd()">ğŸ’¾ Save</button></div></div></div>
<div class="modal" id="bundleModal"><div class="modal-bg" onclick="closeMod('bundleModal')"></div><div class="modal-box"><div class="modal-head"><h3 id="bundleModalTitle">Create Bundle</h3><button class="modal-close" onclick="closeMod('bundleModal')">âœ•</button></div><div class="modal-body"><input type="hidden" id="eBundleId"><div class="field"><label class="field-label">Bundle Name</label><input type="text" class="input" id="bundleName"></div><div class="field"><label class="field-label">Bundle Price</label><input type="number" class="input" id="bundlePrice" min="0" step="0.01"></div><div class="field"><label class="field-label">Select Products</label><div id="bundleProds" style="max-height:150px;overflow-y:auto;background:#f8fafc;border-radius:8px;padding:8px"></div></div></div><div class="modal-foot"><button class="btn btn-g" onclick="closeMod('bundleModal')">Cancel</button><button class="btn btn-p" onclick="saveBundle()">ğŸ’¾ Save</button></div></div></div>
<div class="modal" id="custModal"><div class="modal-bg" onclick="closeMod('custModal')"></div><div class="modal-box"><div class="modal-head"><h3 id="custModalTitle">Add Customer</h3><button class="modal-close" onclick="closeMod('custModal')">âœ•</button></div><div class="modal-body"><input type="hidden" id="eCustId"><div class="field"><label class="field-label">Name</label><input type="text" class="input" id="custName"></div><div class="field"><label class="field-label">Phone</label><input type="tel" class="input" id="custPhone"></div><div class="field"><label class="field-label">Address</label><textarea class="input" id="custAddr"></textarea></div><div class="field"><label class="field-label">Notes</label><textarea class="input" id="custNotes"></textarea></div></div><div class="modal-foot"><button class="btn btn-g" onclick="closeMod('custModal')">Cancel</button><button class="btn btn-p" onclick="saveCust()">ğŸ’¾ Save</button></div></div></div>
<div class="modal" id="selCustModal"><div class="modal-bg" onclick="closeMod('selCustModal')"></div><div class="modal-box"><div class="modal-head"><h3>ğŸ‘¥ Select Customer</h3><button class="modal-close" onclick="closeMod('selCustModal')">âœ•</button></div><div class="modal-body"><input type="tel" class="input" placeholder="ğŸ” Search by phone..." id="selCustQ" oninput="renderSelCust()" style="margin-bottom:10px"><div id="selCustList"></div></div><div class="modal-foot"><button class="btn btn-g" onclick="clearSelCust()">Clear</button><button class="btn btn-p" onclick="openCustModal();closeMod('selCustModal')">â• New</button></div></div></div>
<div class="modal" id="expModal"><div class="modal-bg" onclick="closeMod('expModal')"></div><div class="modal-box"><div class="modal-head"><h3>ğŸ’¸ Add Expense</h3><button class="modal-close" onclick="closeMod('expModal')">âœ•</button></div><div class="modal-body"><div class="field"><label class="field-label">Title</label><input type="text" class="input" id="expTitle"></div><div class="field"><label class="field-label">Category</label><select class="input" id="expCat"><option value="utilities">âš¡ Utilities</option><option value="rent">ğŸ  Rent</option><option value="supplies">ğŸ“¦ Supplies</option><option value="transport">ğŸš— Transport</option><option value="salary">ğŸ‘¤ Salary</option><option value="other">ğŸ“ Other</option></select></div><div class="field"><label class="field-label">Amount</label><input type="number" class="input" id="expAmt" min="0" step="0.01"></div></div><div class="modal-foot"><button class="btn btn-g" onclick="closeMod('expModal')">Cancel</button><button class="btn btn-d" onclick="saveExp()">ğŸ’¾ Save</button></div></div></div>
<div class="modal" id="sfModal"><div class="modal-bg" onclick="closeMod('sfModal')"></div><div class="modal-box"><div class="modal-head"><h3 id="sfModalTitle">Add Staff</h3><button class="modal-close" onclick="closeMod('sfModal')">âœ•</button></div><div class="modal-body"><input type="hidden" id="eSfId"><div class="field"><label class="field-label">Name</label><input type="text" class="input" id="sfName"></div><div class="field"><label class="field-label">Role</label><select class="input" id="sfRole"><option value="cashier">Cashier</option><option value="admin">Admin</option></select></div><div class="field"><label class="field-label">PIN (4 digits)</label><input type="tel" class="input" id="sfPin" maxlength="4" inputmode="numeric"></div></div><div class="modal-foot"><button class="btn btn-g" onclick="closeMod('sfModal')">Cancel</button><button class="btn btn-p" onclick="saveStaff()">ğŸ’¾ Save</button></div></div></div>
<div class="modal" id="heldModal"><div class="modal-bg" onclick="closeMod('heldModal')"></div><div class="modal-box"><div class="modal-head"><h3>ğŸ“‹ Held Carts</h3><button class="modal-close" onclick="closeMod('heldModal')">âœ•</button></div><div class="modal-body" id="heldBody"></div></div></div>
<div class="modal" id="rcptModal"><div class="modal-bg" onclick="closeMod('rcptModal')"></div><div class="modal-box"><div class="modal-head"><h3>ğŸ§¾ Receipt</h3><button class="modal-close" onclick="closeMod('rcptModal')">âœ•</button></div><div class="modal-body" id="rcptBody"></div><div class="modal-foot"><button class="btn btn-g" onclick="closeMod('rcptModal')">Close</button><button class="btn btn-p" onclick="printRcpt()">ğŸ–¨ï¸ Print</button></div></div></div>
<div class="modal" id="stockHistModal"><div class="modal-bg" onclick="closeMod('stockHistModal')"></div><div class="modal-box"><div class="modal-head"><h3>ğŸ“œ Stock History</h3><button class="modal-close" onclick="closeMod('stockHistModal')">âœ•</button></div><div class="modal-body" id="stockHistBody"></div></div></div>
<div class="modal" id="menuModal"><div class="modal-bg" onclick="closeMod('menuModal')"></div><div class="modal-box"><div class="modal-head"><h3>â˜° Menu</h3><button class="modal-close" onclick="closeMod('menuModal')">âœ•</button></div><div class="modal-body"><div style="background:var(--g);border-radius:12px;padding:16px;text-align:center;color:#fff;margin-bottom:14px"><div style="width:50px;height:50px;background:rgba(255,255,255,.2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:700;margin:0 auto 8px" id="menuAv">A</div><h4 id="menuNm">Admin</h4><span style="padding:3px 10px;background:rgba(255,255,255,.2);border-radius:12px;font-size:9px;font-weight:700;margin-top:6px;display:inline-block" id="menuRole">ADMIN</span></div><div style="display:flex;flex-direction:column;gap:6px"><button class="btn btn-g" style="justify-content:flex-start" onclick="goTo('dash');closeMod('menuModal')">ğŸ“Š Dashboard</button><button class="btn btn-g" style="justify-content:flex-start" onclick="goTo('products');closeMod('menuModal')">ğŸ“¦ Products</button><button class="btn btn-g" style="justify-content:flex-start" onclick="goTo('bundles');closeMod('menuModal')">ğŸ Bundles</button><button class="btn btn-g" style="justify-content:flex-start" onclick="goTo('customers');closeMod('menuModal')">ğŸ‘¥ Customers</button><button class="btn btn-g" style="justify-content:flex-start" onclick="goTo('stock');closeMod('menuModal')">ğŸ“‹ Stock Take</button><button class="btn btn-g" style="justify-content:flex-start" onclick="goTo('expenses');closeMod('menuModal')">ğŸ’¸ Expenses</button><button class="btn btn-g" style="justify-content:flex-start" onclick="goTo('reports');closeMod('menuModal')">ğŸ“ˆ Reports</button><button class="btn btn-g" style="justify-content:flex-start" onclick="goTo('staff');closeMod('menuModal')">ğŸ‘¤ Staff</button><button class="btn btn-d" style="justify-content:flex-start;margin-top:10px" onclick="logout()">ğŸšª Logout</button></div></div></div></div>
<div id="printArea"></div>
<script>
const SB='https://gijflxcfxavzdrllqfiv.supabase.co';
const SK='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdpamZseGNmeGF2emRybGxxZml2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4NDczNjksImV4cCI6MjA4NTQyMzM2OX0.uJ5kx3PKe8H8ymoHKxCaAuVFFrpE5t7gVFTHOnhSVV0';
const SHOP={name:'Everytin Room',tag:'Your One Stop Shop',ph1:'054 920 7471',ph2:'024 531 5581',addr:'Adenta Aviation Road',web:'Erbliving.shop'};
const db=window.supabase.createClient(SB,SK);
let shop=null,user=null,products=[],sales=[],staff=[],orders=[],expenses=[],bundles=[],customers=[],stockTakes=[],cart=[],held=[],mode='retail',selCat='all',ordFilter='pending',curRcpt=null,selCust=null,curStock=null;
const $=id=>document.getElementById(id),n=v=>parseFloat(v)||0,m=v=>'GHS '+n(v).toFixed(2);
const toast=(t,ok)=>{const e=$('toast');e.textContent=t;e.className='show'+(ok===true?' ok':ok===false?' err':'');setTimeout(()=>e.className='',2500)};
const show=t=>{$('loadTxt').textContent=t||'Loading...';$('loader').classList.remove('hide')};
const hide=()=>$('loader').classList.add('hide');
const openMod=id=>$(id).classList.add('on'),closeMod=id=>$(id).classList.remove('on');
const openMenu=()=>openMod('menuModal');
const openCart=()=>{$('cart').classList.add('on');$('cartBg').classList.add('on')};
const closeCart=()=>{$('cart').classList.remove('on');$('cartBg').classList.remove('on')};
const fmtD=d=>d?new Date(d).toLocaleDateString('en-GB'):'-';
const fmtDT=d=>d?new Date(d).toLocaleString('en-GB',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'}):'-';
const isoD=d=>d?new Date(d).toISOString().split('T')[0]:'';
const td=()=>new Date().toISOString().split('T')[0];
const catIcon=c=>({utilities:'âš¡',rent:'ğŸ ',supplies:'ğŸ“¦',transport:'ğŸš—',salary:'ğŸ‘¤',other:'ğŸ“'})[c]||'ğŸ“';
async function init(){show('Connecting...');try{const{data:s,error}=await db.from('shops').select('*').eq('slug','everytin-room').single();if(error||!s){$('loadTxt').textContent='Setup required';alert('Shop not found. Run SQL setup first.');return}shop=s;await loadStaff();hide();$('p1').focus()}catch(e){$('loadTxt').textContent='Connection error';alert('Cannot connect to database')}}
function pinIn(i){if($('p'+i).value.length===1&&i<4)$('p'+(i+1)).focus();if(i===4&&$('p4').value)setTimeout(tryLogin,100)}
async function tryLogin(){const pin=$('p1').value+$('p2').value+$('p3').value+$('p4').value;if(pin.length!==4)return;const u=staff.find(s=>s.pin===pin&&s.active);if(u){user=u;$('menuAv').textContent=u.name.charAt(0);$('menuNm').textContent=u.name;$('menuRole').textContent=u.role.toUpperCase();$('login').classList.add('hide');$('app').classList.add('show');await loadAll();setupRT();goTo('pos');toast('Welcome '+u.name+'!',true)}else{$('pin-err').style.display='block';for(let i=1;i<=4;i++)$('p'+i).value='';$('p1').focus();setTimeout(()=>$('pin-err').style.display='none',2500)}}
function logout(){user=null;$('app').classList.remove('show');$('login').classList.remove('hide');for(let i=1;i<=4;i++)$('p'+i).value='';$('p1').focus();cart=[];selCust=null;closeMod('menuModal')}
async function loadAll(){show('Loading data...');await Promise.all([loadProducts(),loadSales(),loadOrders(),loadBundles(),loadExpenses(),loadCustomers(),loadStockTakes()]);renderAll();hide()}
async function loadStaff(){const{data}=await db.from('users').select('*').eq('shop_id',shop.id);staff=data||[]}
async function loadProducts(){const{data}=await db.from('products').select('*').eq('shop_id',shop.id).eq('active',true).order('name');products=data||[]}
async function loadSales(){const{data}=await db.from('sales').select('*,sale_items(*)').eq('shop_id',shop.id).order('created_at',{ascending:false}).limit(200);sales=data||[]}
async function loadOrders(){const{data}=await db.from('whatsapp_orders').select('*,whatsapp_order_items(*)').eq('shop_id',shop.id).order('created_at',{ascending:false});orders=data||[]}
async function loadBundles(){const{data}=await db.from('bundles').select('*,bundle_items(*,products(*))').eq('shop_id',shop.id).eq('active',true);bundles=data||[]}
async function loadExpenses(){const{data}=await db.from('expenses').select('*').eq('shop_id',shop.id).order('created_at',{ascending:false});expenses=data||[]}
async function loadCustomers(){const{data}=await db.from('customers').select('*').eq('shop_id',shop.id).order('name');customers=data||[]}
async function loadStockTakes(){const{data}=await db.from('stock_takes').select('*,stock_take_items(*)').eq('shop_id',shop.id).order('created_at',{ascending:false});stockTakes=data||[]}
function setupRT(){db.channel('pos').on('postgres_changes',{event:'*',schema:'public',table:'sales',filter:`shop_id=eq.${shop.id}`},()=>{loadSales().then(renderAll)}).on('postgres_changes',{event:'*',schema:'public',table:'whatsapp_orders',filter:`shop_id=eq.${shop.id}`},()=>{loadOrders().then(()=>{renderOrders();renderOrdBadge();renderDash()});toast('ğŸ›ï¸ New order!',true)}).on('postgres_changes',{event:'*',schema:'public',table:'products',filter:`shop_id=eq.${shop.id}`},()=>{loadProducts().then(renderPOS)}).subscribe()}
function goTo(pg){document.querySelectorAll('.page').forEach(p=>p.classList.remove('on'));document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('on'));const el=$('pg'+pg.charAt(0).toUpperCase()+pg.slice(1));if(el)el.classList.add('on');document.querySelectorAll(`[data-pg="${pg}"]`).forEach(b=>b.classList.add('on'));if(pg==='reports')initReports()}
function renderAll(){renderDash();renderPOS();renderReceipts();renderProducts();renderStaff();renderCats();renderOrdBadge();renderOrders();renderBundles();renderExpenses();renderCustomers();renderStock()}
function renderDash(){const today=td();let tS=0,tP=0;const ps={};for(const s of sales){if(s.status==='voided'||isoD(s.created_at)!==today)continue;tS+=n(s.total);tP+=n(s.profit);for(const i of(s.sale_items||[]))ps[i.name]=(ps[i.name]||0)+i.quantity}let tE=0;for(const e of expenses)if(isoD(e.created_at)===today)tE+=n(e.amount);$('dSales').textContent=m(tS);$('dProfit').textContent=m(tP);$('dPend').textContent=orders.filter(o=>o.status==='pending').length;$('dExp').textContent=m(tE);const top=Object.entries(ps).sort((a,b)=>b[1]-a[1]).slice(0,5);$('topToday').innerHTML=top.length?top.map((p,i)=>`<div class="top-item"><div class="top-rank">${i+1}</div><div class="top-info"><div class="top-name">${p[0]}</div></div><span class="top-qty">${p[1]} sold</span></div>`).join(''):'<p style="color:#94a3b8;text-align:center;padding:14px;font-size:11px">No sales today</p>'}
function renderOrdBadge(){const c=orders.filter(o=>o.status==='pending').length;$('ordBadge').textContent=c;$('ordBadge').style.display=c>0?'flex':'none';$('pendCnt').textContent=c}
function renderCats(){const cats=[...new Set(products.map(p=>p.category).filter(Boolean))];let h='<button class="cat'+(selCat==='all'?' on':'')+'" onclick="setCat(\'all\')">All</button>';for(const c of cats)h+=`<button class="cat${selCat===c?' on':''}" onclick="setCat('${c}')">${c}</button>`;$('catFilter').innerHTML=h}
function setCat(c){selCat=c;renderCats();renderPOS()}
function setMode(md){mode=md;$('mdRet').classList.toggle('on',md==='retail');$('mdWho').classList.toggle('on',md==='wholesale');$('mdBun').classList.toggle('on',md==='bundle');renderPOS()}
function renderPOS(){const q=($('posQ')?.value||'').toLowerCase();let h='';if(mode==='bundle'){for(const b of bundles)if(b.name.toLowerCase().includes(q))h+=`<div class="product" onclick="addBundle('${b.id}')"><div class="product-img">ğŸ</div><div class="product-name">${b.name}</div><div class="product-price">${m(b.bundle_price)}</div><span class="product-stock ok">Bundle</span></div>`}else{for(const p of products){if(!p.name.toLowerCase().includes(q))continue;if(selCat!=='all'&&p.category!==selCat)continue;const pr=mode==='wholesale'&&n(p.wholesale_price)>0?n(p.wholesale_price):n(p.price);const qt=n(p.quantity),cl=qt===0?'out':qt<=5?'low':'ok';const img=p.image_url?`<img src="${p.image_url}">`:'ğŸ“¦';h+=`<div class="product${qt===0?' out':''}" onclick="addProd('${p.id}')"><div class="product-img">${img}</div><div class="product-name">${p.name}</div><div class="product-price">${m(pr)}</div><span class="product-stock ${cl}">${qt}</span></div>`}}$('prodGrid').innerHTML=h||'<div class="empty" style="grid-column:1/-1"><span>ğŸ“¦</span><p>No products</p></div>'}
function addProd(id){const p=products.find(x=>x.id===id);if(!p||n(p.quantity)===0)return;const pr=mode==='wholesale'&&n(p.wholesale_price)>0?n(p.wholesale_price):n(p.price);const ex=cart.find(c=>c.pid===id);if(ex){if(ex.qty<n(p.quantity)){ex.qty++;ex.total=ex.qty*ex.price}else{toast('Stock limit',false);return}}else cart.push({pid:id,name:p.name,price:pr,cost:n(p.cost_price),qty:1,total:pr,img:p.image_url||''});renderCart();toast('Added',true)}
function addBundle(id){const b=bundles.find(x=>x.id===id);if(!b)return;const ex=cart.find(c=>c.bid===id);if(ex){ex.qty++;ex.total=ex.qty*ex.price}else cart.push({bid:id,name:b.name,price:n(b.bundle_price),cost:0,qty:1,total:n(b.bundle_price),is_b:true});renderCart();toast('Added',true)}
function renderCart(){const cnt=cart.reduce((a,c)=>a+c.qty,0);$('cartCnt').textContent=cnt;$('cartBadge').textContent=cnt;$('payBtn').disabled=cnt===0;$('cartBody').innerHTML=cnt?cart.map((c,i)=>{const img=c.is_b?'ğŸ':(c.img?`<img src="${c.img}">`:'ğŸ“¦');return`<div class="cart-item"><div class="cart-item-img">${img}</div><div class="cart-item-info"><div class="cart-item-name">${c.name}</div><div class="cart-item-price">${m(c.price)}</div></div><div class="cart-qty"><button class="cart-qty-btn" onclick="chgQty(${i},-1)">âˆ’</button><span class="cart-qty-num">${c.qty}</span><button class="cart-qty-btn" onclick="chgQty(${i},1)">+</button></div><span class="cart-item-total">${m(c.total)}</span><button class="cart-item-del" onclick="remItem(${i})">âœ•</button></div>`}).join(''):'<div class="cart-empty"><span>ğŸ›’</span><p>Empty cart</p></div>';calcCart();updHeldBtn()}
function chgQty(i,d){const c=cart[i];if(!c)return;const nq=c.qty+d;if(nq<1){remItem(i);return}if(!c.is_b){const p=products.find(x=>x.id===c.pid);if(p&&nq>n(p.quantity)){toast('Stock limit',false);return}}c.qty=nq;c.total=c.qty*c.price;renderCart()}
function remItem(i){cart.splice(i,1);renderCart()}
function clearCart(){if(!cart.length||!confirm('Clear cart?'))return;cart=[];selCust=null;$('cartCustId').value='';$('custSelBtn').textContent='ğŸ‘¥ Select Customer';$('custSelBtn').classList.remove('sel');renderCart()}
function calcCart(){const sub=cart.reduce((a,c)=>a+c.total,0);const d=n($('cartDisc').value);$('cartSub').textContent=m(sub);$('cartTot').textContent=m(Math.max(0,sub-d))}
function holdCart(){if(!cart.length)return;const name=prompt('Cart name:','Cart '+(held.length+1));if(!name)return;held.push({id:Date.now(),name,items:[...cart],disc:n($('cartDisc').value),time:new Date().toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'}),total:cart.reduce((a,c)=>a+c.total,0),custId:selCust?.id,custNm:selCust?.name});cart=[];selCust=null;$('cartCustId').value='';$('custSelBtn').textContent='ğŸ‘¥ Select Customer';$('custSelBtn').classList.remove('sel');$('cartDisc').value=0;renderCart();toast('Cart held',true)}
function updHeldBtn(){$('heldCnt').textContent=held.length;$('heldBtn').style.display=held.length>0?'inline-flex':'none'}
function openHeld(){if(!held.length)return;$('heldBody').innerHTML=held.map((h,i)=>`<div style="background:#f8fafc;padding:10px;border-radius:10px;margin-bottom:6px;border-left:3px solid var(--a)"><div style="display:flex;justify-content:space-between"><b style="font-size:12px">${h.name}</b><span style="color:#94a3b8;font-size:9px">${h.time}</span></div><div style="font-size:16px;font-weight:800;color:var(--p);margin:6px 0">${m(h.total)}</div><div class="acts"><button class="btn btn-s btn-sm" onclick="recallCart(${i})">ğŸ“¥ Recall</button><button class="btn btn-d btn-sm" onclick="delHeld(${i})">ğŸ—‘ï¸</button></div></div>`).join('');openMod('heldModal')}
function recallCart(i){if(cart.length&&!confirm('Replace cart?'))return;const h=held[i];cart=[...h.items];$('cartDisc').value=h.disc||0;if(h.custId){selCust=customers.find(c=>c.id===h.custId);if(selCust){$('cartCustId').value=selCust.id;$('custSelBtn').textContent='ğŸ‘¤ '+selCust.name;$('custSelBtn').classList.add('sel')}}held.splice(i,1);renderCart();closeMod('heldModal');toast('Cart recalled',true)}
function delHeld(i){held.splice(i,1);if(held.length)openHeld();else closeMod('heldModal');updHeldBtn()}
function openSelCust(){renderSelCust();openMod('selCustModal')}
function renderSelCust(){const q=($('selCustQ')?.value||'').toLowerCase();const f=customers.filter(c=>(c.phone||'').includes(q)||(c.name||'').toLowerCase().includes(q));$('selCustList').innerHTML=f.length?f.map(c=>`<div class="cust-item" onclick="pickCust('${c.id}')" style="margin-bottom:6px"><div class="cust-avatar">${c.name.charAt(0)}</div><div class="cust-info"><div class="cust-name">${c.name}</div><div class="cust-phone">ğŸ“± ${c.phone||'-'}</div></div></div>`).join(''):'<p style="text-align:center;color:#94a3b8;padding:16px;font-size:11px">No customers found</p>'}
function pickCust(id){const c=customers.find(x=>x.id===id);if(!c)return;selCust=c;$('cartCustId').value=c.id;$('custSelBtn').textContent='ğŸ‘¤ '+c.name;$('custSelBtn').classList.add('sel');closeMod('selCustModal');toast(c.name+' selected',true)}
function clearSelCust(){selCust=null;$('cartCustId').value='';$('custSelBtn').textContent='ğŸ‘¥ Select Customer';$('custSelBtn').classList.remove('sel');closeMod('selCustModal')}
function openPayModal(){if(!cart.length)return;$('payMethod').value='cash';$('payTotal').textContent=m(cart.reduce((a,c)=>a+c.total,0)-n($('cartDisc').value));openMod('payModal')}
ySelectorAll('.bp-chk:checked')].map(c=>c.dataset.id);if(!prods.length){toast('Select products',false);return}show('Saving...');let bid=id;if(id){await db.from('bundles').update({name,bundle_price:price}).eq('id',id);await db.from('bundle_items').delete().eq('bundle_id',id)}else{const{data}=await db.from('bundles').insert({shop_id:shop.id,name,bundle_price:price}).select().single();bid=data?.id}if(bid)await db.from('bundle_items').insert(prods.map(pid=>({bundle_id:bid,product_id:pid,quantity:1})));hide();toast('Bundle saved',true);closeMod('bundleModal');await loadBundles();renderBundles();renderPOS()}
async function delBundle(id){if(!confirm('Delete bundle?'))return;show('Deleting...');await db.from('bundles').update({active:false}).eq('id',id);hide();toast('Bundle deleted',true);await loadBundles();renderBundles();renderPOS()}
function renderCustomers(){$('custTot').textContent=customers.length;$('custPts').textContent=customers.reduce((a,c)=>a+n(c.loyalty_points),0);$('custRev').textContent=m(customers.reduce((a,c)=>a+n(c.total_purchases),0));const q=($('custQ')?.value||'').toLowerCase();const f=customers.filter(c=>(c.phone||'').includes(q)||(c.name||'').toLowerCase().includes(q));$('custList').innerHTML=f.length?f.map(c=>`<div class="cust-item" onclick="viewCust('${c.id}')"><div class="cust-avatar">${c.name.charAt(0)}</div><div class="cust-info"><div class="cust-name">${c.name}</div><div class="cust-phone">ğŸ“± ${c.phone||'-'}</div><div class="cust-stats"><div><span class="cust-stat-val">${n(c.total_visits)}</span> <span class="cust-stat-lbl">visits</span></div><div><span class="cust-stat-val">${m(c.total_purchases)}</span> <span class="cust-stat-lbl">spent</span></div><div><span class="cust-stat-val">${n(c.loyalty_points)}</span> <span class="cust-stat-lbl">pts</span></div></div></div></div>`).join(''):'<p style="text-align:center;color:#94a3b8;padding:20px;font-size:11px">No customers</p>'}
function openCustModal(){$('custModalTitle').textContent='Add Customer';$('eCustId').value='';$('custName').value='';$('custPhone').value='';$('custAddr').value='';$('custNotes').value='';openMod('custModal')}
function viewCust(id){const c=customers.find(x=>x.id===id);if(!c)return;$('custModalTitle').textContent='Edit Customer';$('eCustId').value=c.id;$('custName').value=c.name;$('custPhone').value=c.phone||'';$('custAddr').value=c.address||'';$('custNotes').value=c.notes||'';openMod('custModal')}
async function saveCust(){const id=$('eCustId').value,data={shop_id:shop.id,name:$('custName').value.trim(),phone:$('custPhone').value.trim(),address:$('custAddr').value.trim()||null,notes:$('custNotes').value.trim()||null};if(!data.name||!data.phone){toast('Name & Phone required',false);return}show('Saving...');let err;if(id)({error:err}=await db.from('customers').update(data).eq('id',id));else({error:err}=await db.from('customers').insert(data));hide();if(err){toast('Error',false);return}toast('Customer saved',true);closeMod('custModal');await loadCustomers();renderCustomers()}
function renderExpenses(){const mo=new Date().toISOString().slice(0,7);let tot=0;for(const e of expenses)if(e.created_at.slice(0,7)===mo)tot+=n(e.amount);$('expMonth').textContent=m(tot);$('expList').innerHTML=expenses.length?expenses.slice(0,25).map(e=>`<div class="exp-item"><div class="exp-icon">${catIcon(e.category)}</div><div class="exp-info"><div class="exp-title">${e.title}</div><div class="exp-date">${fmtD(e.created_at)} â€¢ ${e.category}</div></div><div class="exp-amt">-${m(e.amount)}</div><button class="btn btn-d btn-sm" onclick="delExp('${e.id}')">ğŸ—‘ï¸</button></div>`).join(''):'<div class="empty"><span>ğŸ’¸</span>No expenses</div>'}
function openExpModal(){$('expTitle').value='';$('expCat').value='utilities';$('expAmt').value='';openMod('expModal')}
async function saveExp(){const title=$('expTitle').value.trim(),amt=n($('expAmt').value);if(!title||!amt){toast('Title & Amount required',false);return}show('Saving...');const{error}=await db.from('expenses').insert({shop_id:shop.id,user_id:user.id,title,category:$('expCat').value,amount:amt});hide();if(error){toast('Error',false);return}toast('Expense added',true);closeMod('expModal');await loadExpenses();renderExpenses();renderDash()}
async function delExp(id){if(!confirm('Delete expense?'))return;show('Deleting...');await db.from('expenses').delete().eq('id',id);hide();toast('Expense deleted',true);await loadExpenses();renderExpenses();renderDash()}
function initReports(){const t=new Date(),y=t.getFullYear(),mo=t.getMonth();$('repFrom').value=new Date(y,mo,1).toISOString().split('T')[0];$('repTo').value=t.toISOString().split('T')[0];renderReports()}
function renderReports(){const from=$('repFrom').value,to=$('repTo').value;let tS=0,tP=0;const ps={};for(const s of sales){if(s.status==='voided')continue;const d=isoD(s.created_at);if(d>=from&&d<=to){tS+=n(s.total);tP+=n(s.profit);for(const i of(s.sale_items||[])){if(!ps[i.name])ps[i.name]={qty:0,total:0};ps[i.name].qty+=i.quantity;ps[i.name].total+=n(i.line_total)}}}let tE=0;for(const e of expenses){const d=isoD(e.created_at);if(d>=from&&d<=to)tE+=n(e.amount)}const net=tP-tE;$('repSales').textContent=m(tS);$('repProfit').textContent=m(tP);$('repExp').textContent=m(tE);$('repNet').textContent=m(net);$('repNet').style.color=net>=0?'var(--s)':'var(--d)';const top=Object.entries(ps).sort((a,b)=>b[1].total-a[1].total).slice(0,10);$('topProdList').innerHTML=top.length?top.map((p,i)=>`<div class="top-item"><div class="top-rank">${i+1}</div><div class="top-info"><div class="top-name">${p[0]}</div><span class="top-qty">${p[1].qty} sold</span></div><div class="top-total">${m(p[1].total)}</div></div>`).join(''):'<p style="color:#94a3b8;text-align:center;padding:16px;font-size:11px">No data for period</p>'}
function renderStaff(){$('sfTbl').innerHTML=staff.map(s=>`<tr><td><b>${s.name}</b></td><td><span style="padding:3px 6px;border-radius:6px;font-size:8px;font-weight:700;background:${s.role==='admin'?'rgba(13,148,136,.1)':'rgba(34,197,94,.1)'};color:${s.role==='admin'?'var(--p)':'var(--s)'}">${s.role}</span></td><td><span style="padding:3px 6px;border-radius:6px;font-size:8px;font-weight:700;background:${s.active?'rgba(34,197,94,.1)':'rgba(239,68,68,.1)'};color:${s.active?'var(--s)':'var(--d)'}">${s.active?'Active':'Off'}</span></td><td><div class="acts"><button class="btn btn-g btn-sm" onclick="editStaff('${s.id}')">âœï¸</button><button class="btn btn-d btn-sm" onclick="delStaff('${s.id}')">ğŸ—‘ï¸</button></div></td></tr>`).join('')||'<tr><td colspan="4"><div class="empty">No staff</div></td></tr>'}
function openStaffModal(){$('sfModalTitle').textContent='Add Staff';$('eSfId').value='';$('sfName').value='';$('sfRole').value='cashier';$('sfPin').value='';openMod('sfModal')}
function editStaff(id){const s=staff.find(x=>x.id===id);if(!s)return;$('sfModalTitle').textContent='Edit Staff';$('eSfId').value=s.id;$('sfName').value=s.name;$('sfRole').value=s.role;$('sfPin').value=s.pin;openMod('sfModal')}
async function saveStaff(){const id=$('eSfId').value,data={shop_id:shop.id,name:$('sfName').value.trim(),role:$('sfRole').value,pin:$('sfPin').value.trim(),active:true};if(!data.name||data.pin.length!==4){toast('Name & 4-digit PIN required',false);return}show('Saving...');let err;if(id)({error:err}=await db.from('users').update(data).eq('id',id));else({error:err}=await db.from('users').insert(data));hide();if(err){toast('Error',false);return}toast('Staff saved',true);closeMod('sfModal');await loadStaff();renderStaff()}
async function delStaff(id){if(!confirm('Delete staff?'))return;show('Deleting...');await db.from('users').update({active:false}).eq('id',id);hide();toast('Staff deleted',true);await loadStaff();renderStaff()}
function renderStock(){const active=stockTakes.find(st=>st.status==='in_progress');if(active){curStock=active;renderActiveStock()}else{curStock=null;$('stockArea').innerHTML=`<div class="card" style="text-align:center;padding:30px"><span style="font-size:48px;opacity:.2">ğŸ“‹</span><p style="color:#64748b;margin:14px 0;font-size:12px">No active stock take</p><button class="btn btn-p" onclick="startStock()">â• Start Stock Take</button></div>`}}
async function startStock(){if(curStock){toast('Complete current first',false);return}if(!confirm('Start new stock take?'))return;show('Starting...');const ref='ST-'+Date.now().toString(36).toUpperCase();const{data:st,error}=await db.from('stock_takes').insert({shop_id:shop.id,user_id:user.id,reference_no:ref,status:'in_progress',total_items:products.length}).select().single();if(error){hide();toast('Error',false);return}const items=products.map(p=>({stock_take_id:st.id,product_id:p.id,product_name:p.name,system_qty:n(p.quantity),counted_qty:null,variance:0,variance_value:0}));await db.from('stock_take_items').insert(items);hide();toast(ref+' started',true);await loadStockTakes();renderStock()}
function renderActiveStock(){const st=curStock,items=st.stock_take_items||[];const counted=items.filter(i=>i.counted_qty!==null).length;const pct=items.length?Math.round(counted/items.length*100):0;const totVar=items.reduce((a,i)=>a+n(i.variance),0);const varVal=items.reduce((a,i)=>a+n(i.variance_value),0);$('stockArea').innerHTML=`<div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><div><b style="font-size:14px">ğŸ“‹ ${st.reference_no}</b><div style="font-size:10px;color:#64748b;margin-top:2px">${fmtDT(st.created_at)}</div></div><span style="padding:4px 10px;background:rgba(245,158,11,.1);color:var(--a);border-radius:10px;font-size:9px;font-weight:700">In Progress</span></div><div class="stock-sum"><div class="stock-sum-card"><div class="stock-sum-val">${counted}/${items.length}</div><div class="stock-sum-lbl">Counted</div></div><div class="stock-sum-card"><div class="stock-sum-val" style="color:${totVar>=0?'var(--s)':'var(--d)'}">${totVar>=0?'+':''}${totVar}</div><div class="stock-sum-lbl">Variance</div></div><div class="stock-sum-card"><div class="stock-sum-val" style="color:${varVal>=0?'var(--s)':'var(--d)'}">${m(Math.abs(varVal))}</div><div class="stock-sum-lbl">Value</div></div></div><div class="stock-prog"><div class="stock-prog-bar" style="width:${pct}%"></div></div><p style="text-align:center;font-size:10px;color:#64748b;margin-bottom:12px">${pct}% complete</p><div class="acts" style="margin-bottom:12px"><button class="btn btn-s" onclick="completeStock()" ${pct<100?'disabled':''}>âœ… Complete</button><button class="btn btn-d" onclick="cancelStock()">âŒ Cancel</button></div><input type="text" class="input" placeholder="ğŸ” Search product..." id="stQ" oninput="filterStockItems()" style="margin-bottom:10px"><div id="stockItems">${renderStockItems(items)}</div></div>`}
function renderStockItems(items){const q=($('stQ')?.value||'').toLowerCase();const f=items.filter(i=>i.product_name.toLowerCase().includes(q));return f.map(i=>{const v=n(i.variance);const cls=i.counted_qty===null?'':(v>0?'pos':v<0?'neg':'');return`<div class="stock-item ${cls}"><div class="stock-info"><div class="stock-name">${i.product_name}</div></div><div class="stock-qty"><div class="stock-qty-lbl">System</div><div class="stock-qty-val">${i.system_qty}</div></div><div><input type="number" class="stock-inp" value="${i.counted_qty!==null?i.counted_qty:''}" placeholder="?" min="0" onchange="updStockCnt('${i.id}',this.value)"></div><div class="stock-var ${v>0?'pos':v<0?'neg':'zero'}">${v>0?'+':''}${v}</div></div>`}).join('')||'<p style="text-align:center;color:#94a3b8;padding:16px;font-size:11px">No items</p>'}
function filterStockItems(){if(!curStock)return;$('stockItems').innerHTML=renderStockItems(curStock.stock_take_items||[])}
async function updStockCnt(itemId,val){const counted=val===''?null:n(val);const item=(curStock.stock_take_items||[]).find(i=>i.id===itemId);if(!item)return;const variance=counted!==null?counted-item.system_qty:0;const prod=products.find(p=>p.id===item.product_id);const varVal=variance*(prod?n(prod.cost_price):0);await db.from('stock_take_items').update({counted_qty:counted,variance,variance_value:varVal,counted_at:counted!==null?new Date().toISOString():null}).eq('id',itemId);item.counted_qty=counted;item.variance=variance;item.variance_value=varVal;renderActiveStock()}
async function completeStock(){if(!curStock||!confirm('Complete & apply stock?'))return;show('Applying...');const items=curStock.stock_take_items||[];for(const i of items)if(i.counted_qty!==null&&i.product_id)await db.from('products').update({quantity:i.counted_qty}).eq('id',i.product_id);const totVar=items.reduce((a,i)=>a+n(i.variance),0);const varVal=items.reduce((a,i)=>a+n(i.variance_value),0);await db.from('stock_takes').update({status:'completed',completed_at:new Date().toISOString(),total_variance:totVar,variance_value:varVal}).eq('id',curStock.id);hide();toast('Stock take completed',true);await loadProducts();await loadStockTakes();renderStock();renderPOS()}
async function cancelStock(){if(!curStock||!confirm('Cancel stock take?'))return;show('Cancelling...');await db.from('stock_takes').update({status:'cancelled'}).eq('id',curStock.id);hide();toast('Stock take cancelled');await loadStockTakes();renderStock()}
function viewStockHist(){const done=stockTakes.filter(st=>st.status!=='in_progress');$('stockHistBody').innerHTML=done.length?done.map(st=>`<div class="card" style="margin-bottom:8px;border-left:3px solid ${st.status==='completed'?'var(--s)':'var(--d)'}"><div style="display:flex;justify-content:space-between;align-items:center"><b style="font-size:12px">${st.reference_no}</b><span style="padding:3px 8px;background:${st.status==='completed'?'rgba(34,197,94,.1)':'rgba(239,68,68,.1)'};color:${st.status==='completed'?'var(--s)':'var(--d)'};border-radius:8px;font-size:8px;font-weight:700">${st.status}</span></div><div style="font-size:10px;color:#64748b;margin-top:4px">${fmtDT(st.created_at)}</div><div style="font-size:11px;margin-top:8px">Variance: <b style="color:${n(st.total_variance)>=0?'var(--s)':'var(--d)'}">${n(st.total_variance)>=0?'+':''}${n(st.total_variance)}</b> (${m(st.variance_value||0)})</div></div>`).join(''):'<p style="text-align:center;color:#94a3b8;padding:20px;font-size:11px">No stock take history</p>';openMod('stockHistModal')}
document.addEventListener('DOMContentLoaded',init);
</script>
</body>
</html>
